<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Horario Extra (SÃ¡bados) - UNL</title>
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" />
  <style>
    body { font-family:'Segoe UI',sans-serif; margin:0; padding:20px; background:#f7f9fc; color:#222;
  display: none; }
    .encabezado { display:flex; justify-content:space-between; align-items:center; padding:10px 20px; border-bottom:2px solid #ccc; margin-bottom:20px; }
    .encabezado img { height:60px; }
    .texto-centro { text-align:center; flex:1; padding:0 10px; font-size:14px; line-height:1.4; }
    .texto-centro strong { display:block; font-size:16px; }
    .horario-titulo { font-weight:bold; margin-top:5px; color:#004a99; }

    .controls { margin:10px 0 16px; display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    .controls label { font-weight:bold; }
    .acciones { margin-left:auto; display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .btn { display:inline-flex; align-items:center; gap:6px; background:#1976D2; color:#fff; border:none; padding:8px 12px; font-size:14px; border-radius:6px; cursor:pointer; }
    .btn.secondary { background:#43A047; }
    .btn.warn { background:#f39c12; }
    .btn:hover { filter:brightness(1.05); }

    #bannerEdicion { display:none; background:#fff3cd; color:#664d03; border:1px solid #ffecb5; padding:10px 12px; border-radius:6px; font-size:14px; margin-bottom:10px; }
    #bannerEdicion strong { margin-right:10px; }

    table { border-collapse:collapse; width:100%; background:#fff; border:1px solid #aaa; box-shadow:0 2px 8px rgba(0,0,0,.1); table-layout:fixed; }
    th, td { border:1px solid #ccc; padding:8px; text-align:center; min-width:120px; white-space:pre-line; font-size:13px; }
    th { background:#004a99; color:#fff; }
    td.boton { background:#cce5ff; cursor:pointer; }
    td:hover { background:#e6f0ff; }

    .modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,.5); justify-content:center; align-items:center; z-index:1000; }
    .modal-content { background:#fff; padding:20px; border-radius:8px; width:420px; max-width:92vw; box-shadow:0 2px 10px rgba(0,0,0,.3); }
    .modal-content h3 { margin:0 0 8px 0; }
    .field { margin-top:10px; }
    .field label { display:block; font-size:13px; font-weight:600; margin-bottom:4px; }
    input, select { width:100%; padding:8px; font-size:1em; box-sizing:border-box; }
    .modal-buttons { display:flex; gap:10px; justify-content:space-between; margin-top:15px; }
    .subtle { font-size:12px; color:#666; }
  </style>
</head>
<body>
  <div class="encabezado">
    <img src="logounl.png" alt="Logo UNL" />
    <div class="texto-centro">
      <strong>UNIVERSIDAD NACIONAL DE LOJA</strong>
      ÃREA DE LA ENERGÃA, LAS INDUSTRIAS Y LOS RECURSOS NATURALES NO RENOVABLES<br />
      CARRERA: TELECOMUNICACIONES<br />
      <div class="horario-titulo">Horario Extra de RecuperaciÃ³n (SÃ³lo SÃ¡bados)</div>
    </div>
    <img src="logocit.png" alt="Logo CIT" />
  </div>
<button id="btnLogout" class="btn-mini warn" onclick="firebase.auth().signOut().then(() => { window.location.href = 'login.html'; })">
            ğŸšª Cerrar SesiÃ³n
        </button>
  <div class="controls">
    <label>Selecciona sÃ¡bado:
      <input type="text" id="sabadoPicker" placeholder="Elige un sÃ¡bado" />
    </label>
    <div id="fechaElegida" class="subtle"></div>

    <div class="acciones">
      <button class="btn" onclick="activarModoEdicion()">âœï¸ Editar horario</button>
      <button class="btn secondary" onclick="desactivarModoEdicion()">âœ… Terminar ediciÃ³n</button>
    </div>
  </div>

  <div id="bannerEdicion">
    <strong>ğŸŸ¡ Modo ediciÃ³n activo:</strong> haz clic en una celda para crear/editar bloques.
  </div>

  <table id="tablaExtra">
    <thead>
      <tr>
        <th>Hora</th>
        <th>SÃ¡bado</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <!-- Modal con el MISMO formato del horario original -->
  <div class="modal" id="modalHorario">
    <div class="modal-content">
      <h3>Definir clase</h3>

      <div class="field">
        <label for="inputCiclo">Ciclo</label>
        <select id="inputCiclo">
          <option value="">Selecciona ciclo...</option>
          <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option>
          <option>6</option><option>7</option><option>8</option><option>9</option><option>10</option>
        </select>
      </div>

      <div class="field">
        <label for="inputAsignatura">Asignatura</label>
        <select id="inputAsignatura">
          <option value="">Selecciona asignatura...</option>
          <!-- Se llena segÃºn ciclo desde clases_definidas. Incluye â€œOTRA ASIGNATURAâ€¦â€ -->
        </select>
      </div>

      <div class="field">
        <label>Docente</label>
        <input id="inputProfesorAuto" type="text" disabled />
      </div>

      <div class="field">
        <label for="inputDuracion">DuraciÃ³n</label>
        <select id="inputDuracion">
          <option value="1">DuraciÃ³n: 1 hora</option>
          <option value="2">DuraciÃ³n: 2 horas</option>
          <option value="3">DuraciÃ³n: 3 horas</option>
          <option value="4">DuraciÃ³n: 4 horas</option>
        </select>
      </div>

      <div class="modal-buttons">
        <button class="btn" onclick="guardarHorarioModal()">Guardar</button>
        <button class="btn warn" onclick="eliminarHorarioModal()">Eliminar</button>
        <button class="btn" onclick="cerrarModal()">Cancelar</button>
      </div>
      <div class="subtle">Se guardarÃ¡ sÃ³lo para el sÃ¡bado seleccionado (07:00â€“21:00).</div>
    </div>
  </div>

  <script>
Â  Â  // ---------- Firebase ----------
Â  Â  const firebaseConfig = {
Â  Â  Â  apiKey: "AIzaSyBByttCwTn1hMwo9X5P2gbsYlSq9lGa7t0",
Â  Â  Â  authDomain: "escaner-qr-d7d65.firebaseapp.com",
Â  Â  Â  projectId: "escaner-qr-d7d65",
Â  Â  Â  storageBucket: "escaner-qr-d7d65.appspot.com",
Â  Â  Â  messagingSenderId: "982923527298",
Â  Â  Â  appId: "1:982923527298:web:df13850f38d847cfdae09b"
Â  Â  };
Â  Â  firebase.initializeApp(firebaseConfig);
Â  Â  const db = firebase.firestore();
Â  Â  const auth = firebase.auth(); // Referencia al mÃ³dulo de Auth

Â  Â  // ---------- Variables globales y Refs DOM ----------
Â  Â  const ALL_ASIGNATURAS = [
Â  Â  Â  "MatemÃ¡tica Discreta","ExpresiÃ³n Oral y Escrita","CÃ¡lculo de Una Variable","FÃ­sica BÃ¡sica","Ãlgebra Lineal",
Â  Â  Â  "Fundamentos de ProgramaciÃ³n","Ecuaciones Diferenciales","CÃ¡lculo Multivariable","Interculturalidad","FÃ­sica Aplicada",
Â  Â  Â  "Probabilidad y EstadÃ­stica","Circuitos ElÃ©ctricos","ElectrÃ³nica AnalÃ³gica y Digital","Ã‰tica Profesional","TeorÃ­a ElectromagnÃ©tica",
Â  Â  Â  "ProgramaciÃ³n Aplicada","SeÃ±ales y Sistemas","Procesos EstocÃ¡sticos","LÃ­neas de TransmisiÃ³n","Comunicaciones AnalÃ³gicas",
Â  Â  Â  "TeorÃ­a de la InformaciÃ³n","Sistemas Microprocesados","InnovaciÃ³n y Emprendimiento","Procesamiento Digital de SeÃ±ales",
Â  Â  Â  "Fundamentos de Redes de Datos","ElectrÃ³nica de Alta Frecuencia","Comunicaciones Digitales","IngenierÃ­a de TrÃ¡fico","Antenas",
Â  Â  Â  "Comunicaciones Ã“pticas","Redes de Datos","Redes para el Desarrollo Comunitario","Sistemas Operativos",
Â  Â  Â  "Fundamentos de Internet de las Cosas","RadiopropagaciÃ³n","Comunicaciones Unificadas","IngenierÃ­a EconÃ³mica",
Â  Â  Â  "MetodologÃ­a de la InvestigaciÃ³n CientÃ­fica","Comunicaciones InalÃ¡mbricas","Redes de Acceso","Internet de las Cosas",
Â  Â  Â  "Proyecto de TitulaciÃ³n","Seguridad de Redes","EducaciÃ³n Ambiental","Marco Regulatorio de las Telecomunicaciones",
Â  Â  Â  "Aplicaciones de Ciudades Inteligentes","Aplicaciones de Telecomunicaciones","Redes Celulares",
Â  Â  Â  "DiseÃ±o, AdministraciÃ³n y GestiÃ³n de Proyectos de Telecomunicaciones","Unidad de IntegraciÃ³n Curricular"
Â  Â  ].map(s => s.toUpperCase());

Â  Â  const dias = ["sabado"];
Â  Â  const horas = generarHoras("07:00","21:00");
Â  Â  const tbody = document.querySelector("#tablaExtra tbody");

Â  Â  // Estado
Â  Â  let modoEdicion = false;
Â  Â  let celdaActual = null;
Â  Â  let fechaSabadoISO = null; // YYYY-MM-DD
Â  Â  const datosExtra = {}; // cache de documentos del sÃ¡bado seleccionado
Â  Â  const clasesPorCiclo = {}; // cache { "5":[{asignatura, profesor}, ...] }

Â  Â  // Funciones expuestas globalmente (necesarias para los onclick)
    window.cerrarSesion = cerrarSesion;
    window.activarModoEdicion = activarModoEdicion;
    window.desactivarModoEdicion = desactivarModoEdicion;
    window.guardarHorarioModal = guardarHorarioModal;
    window.eliminarHorarioModal = eliminarHorarioModal;
    window.cerrarModal = cerrarModal;

Â  Â  // ---------- FunciÃ³n para cerrar sesiÃ³n ----------
    async function cerrarSesion() {
        try {
            await auth.signOut();
            window.location.href = 'login.html';
        } catch (error) {
            console.error("Error al cerrar sesiÃ³n:", error);
            alert("Hubo un error al cerrar sesiÃ³n. Intente de nuevo.");
        }
    }


    // -------------------------------------------------------------------------------------
    // ğŸ“ FUNCIÃ“N DE INICIALIZACIÃ“N (Contiene TODA la lÃ³gica de la UI que debe ser protegida)
    // -------------------------------------------------------------------------------------
    function inicializarUI() {
        
        // ---------- Picker de sÃ¡bados (INICIALIZACIÃ“N MOVIDA AQUÃ) ----------
        const picker = flatpickr("#sabadoPicker", {
            dateFormat: "Y-m-d",
            defaultDate: proximoSabado(new Date()),
            enable: [date => date.getDay() === 6], // 6 = sÃ¡bado
            onChange: ([d]) => {
                fechaSabadoISO = toISO(d);
                document.getElementById("fechaElegida").textContent = formatearFechaLarga(d);
                cargarTabla();
            }
        });

        // Evento DOMContentLoaded simulado para la carga inicial
        (async () => {
            const d = picker.selectedDates[0] || proximoSabado(new Date());
            fechaSabadoISO = toISO(d);
            document.getElementById("fechaElegida").textContent = formatearFechaLarga(d);
            
            // Precarga de ciclos (cache)
            // Se usa Promise.all para cargar en paralelo
            await Promise.all(["1","2","3","4","5","6","7","8","9","10"].map(c => precargarClasesCiclo(c)));
            
            // Carga inicial de la tabla
            await cargarTabla();

            // Listeners de los selects del Modal (AHORA SE ASIGNAN DESPUÃ‰S DE QUE EL DOM ESTÃ LISTO)
            document.getElementById("inputCiclo").addEventListener("change", actualizarOpcionesAsignaturas);
            document.getElementById("inputAsignatura").addEventListener("change", actualizarDocenteAuto);

            // ğŸ’¡ Mostrar el cuerpo de la pÃ¡gina despuÃ©s de la autorizaciÃ³n y la carga inicial
            document.body.style.display = 'block';
        })();
    }


Â  Â  // ---------- Utilidades Fecha/Hora ----------
Â  Â  function generarHoras(desde,hasta){
Â  Â  Â  const arr=[]; let [h1,m1]=desde.split(":").map(Number), [h2,m2]=hasta.split(":").map(Number);
Â  Â  Â  let t=h1*60+m1, fin=h2*60+m2;
Â  Â  Â  while(t<fin){ const H=Math.floor(t/60), M=t%60; arr.push(`${String(H).padStart(2,"0")}:${String(M).padStart(2,"0")}`); t+=60; }
Â  Â  Â  return arr;
Â  Â  }
Â  Â  function sumarHoras(hora, n){ let [H,M]=hora.split(":").map(Number); H+=n; if(H>=24) H-=24; return `${String(H).padStart(2,"0")}:${String(M).padStart(2,"0")}`; }
Â  Â  function convertirHoraANum(h){ const [H,M]=h.split(":").map(Number); return H+M/60; }
Â  Â  function toISO(date){ const y=date.getFullYear(), m=String(date.getMonth()+1).padStart(2,"0"), d=String(date.getDate()).padStart(2,"0"); return `${y}-${m}-${d}`; }
Â  Â  function formatearFechaLarga(date){ return date.toLocaleDateString("es-ES",{weekday:"long",year:"numeric",month:"long",day:"numeric"}); }
Â  Â  function proximoSabado(base){ const d=new Date(base); const diff=(6-d.getDay()+7)%7; d.setDate(d.getDate()+(diff===0?0:diff)); return d; }

Â  Â  // ---------- Render ----------
Â  Â  async function cargarTabla(){
Â  Â  Â  tbody.innerHTML="";
Â  Â  Â  for (const k in datosExtra) delete datosExtra[k];

Â  Â  Â  // Cargar sÃ³lo documentos del sÃ¡bado seleccionado
Â  Â  Â  const snap = await db.collection("horario_extra").where("fecha","==",fechaSabadoISO).get();
Â  Â  Â  snap.forEach(doc => datosExtra[doc.id] = doc.data());

Â  Â  Â  const celdasOcupadas = new Set();

Â  Â  Â  horas.forEach(hora=>{
Â  Â  Â  Â  const tr = document.createElement("tr");
Â  Â  Â  Â  tr.innerHTML = `<td>${hora} - ${sumarHoras(hora, 1)}</td>`;

Â  Â  Â  Â  const celdaKey = `sabado_${hora}`;
Â  Â  Â  Â  if (celdasOcupadas.has(celdaKey)) {
Â  Â  Â  Â  Â  // cubierta por rowspan previo
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  let bloque=null;
Â  Â  Â  Â  Â  for (const id in datosExtra){
Â  Â  Â  Â  Â  Â  const b = datosExtra[id];
Â  Â  Â  Â  Â  Â  const inicio=convertirHoraANum(b.hora), fin=convertirHoraANum(b.hora_fin), hnum=convertirHoraANum(hora);
Â  Â  Â  Â  Â  Â  if (hnum>=inicio && hnum<fin){ bloque=b; break; }
Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  const td=document.createElement("td");
Â  Â  Â  Â  Â  td.dataset.dia="sabado";
Â  Â  Â  Â  Â  td.dataset.hora=hora;

Â  Â  Â  Â  Â  if (bloque){
Â  Â  Â  Â  Â  Â  const dur = convertirHoraANum(bloque.hora_fin) - convertirHoraANum(bloque.hora);
Â  Â  Â  Â  Â  Â  for (let i=0;i<dur;i++){ celdasOcupadas.add(`sabado_${sumarHoras(bloque.hora,i)}`); }
Â  Â  Â  Â  Â  Â  td.rowSpan=dur; td.classList.add("boton"); td.dataset.guardado="true";
Â  Â  Â  Â  Â  Â  td.innerText = `${(bloque.asignatura||"").toUpperCase()}\n${bloque.profesor||""}${bloque.ciclo?'\n'+bloque.ciclo:''}`;
Â  Â  Â  Â  Â  Â  td.onclick=()=>manejarClickCelda(td);
Â  Â  Â  Â  Â  }else{
Â  Â  Â  Â  Â  Â  td.dataset.guardado="false"; td.innerText=""; td.onclick=()=>manejarClickCelda(td);
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  tr.appendChild(td);
Â  Â  Â  Â  }
Â  Â  Â  Â  tbody.appendChild(tr);
Â  Â  Â  });
Â  Â  }

Â  Â  function manejarClickCelda(td){
Â  Â  Â  if (modoEdicion || td.dataset.guardado==="false"){
Â  Â  Â  Â  abrirModal(td);
Â  Â  Â  }else{
Â  Â  Â  Â  // Ir a asistencia.html
Â  Â  Â  Â  const dia="sabado", hora=td.dataset.hora;
Â  Â  Â  Â  const [y,m,d]=fechaSabadoISO.split("-");
Â  Â  Â  Â  const fechaParam=`${parseInt(d)}/${parseInt(m)}/${y}`;
Â  Â  Â  Â  window.open(`asistencia.html?dia=${dia}&hora=${hora}&fecha=${fechaParam}`,"_blank");
Â  Â  Â  }
Â  Â  }

Â  Â  function activarModoEdicion(){ modoEdicion=true; document.getElementById("bannerEdicion").style.display="block"; alert("Modo ediciÃ³n activado. Haz clic en una celda para crear/editar."); }
Â  Â  function desactivarModoEdicion(){ modoEdicion=false; document.getElementById("bannerEdicion").style.display="none"; }

Â  Â  // ---------- Modal (idÃ©ntico flujo) ----------
Â  Â  let celdaEnEdicion=null;

Â  Â  async function abrirModal(td){
Â  Â  Â  celdaEnEdicion=td;
Â  Â  Â  document.getElementById("modalHorario").style.display="flex";

Â  Â  Â  // Reset
Â  Â  Â  document.getElementById("inputCiclo").value="";
Â  Â  Â  document.getElementById("inputAsignatura").innerHTML=`<option value="">Selecciona asignatura...</option>`;
Â  Â  Â  document.getElementById("inputProfesorAuto").value="";
Â  Â  Â  document.getElementById("inputDuracion").value="1";

Â  Â  Â  // Si hay bloque existente que inicie exactamente a esa hora, precargar
Â  Â  Â  const existente = await obtenerClaseExacta(td);
Â  Â  Â  if (existente){
Â  Â  Â  Â  document.getElementById("inputCiclo").value = existente.ciclo||"";
Â  Â  Â  Â  await actualizarOpcionesAsignaturas();
Â  Â  Â  Â  const sel = document.getElementById("inputAsignatura");
Â  Â  Â  Â  let found=false;
Â  Â  Â  Â  [...sel.options].forEach(op=>{ if (op.value===(existente.asignatura||"").toUpperCase()){ sel.value=op.value; found=true; }});
Â  Â  Â  Â  if (!found && existente.asignatura) {
Â  Â  Â  Â  Â  sel.insertAdjacentHTML("beforeend", `<option value="${existente.asignatura}" selected>${existente.asignatura}</option>`);
          // Si no estÃ¡ en clases_definidas, el profesor debe ser el guardado
Â  Â  Â  Â  Â  document.getElementById("inputProfesorAuto").value = existente.profesor||"";
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  await actualizarDocenteAuto();
Â  Â  Â  Â  }
Â  Â  Â  Â  const dur = convertirHoraANum(existente.hora_fin)-convertirHoraANum(existente.hora);
Â  Â  Â  Â  document.getElementById("inputDuracion").value=String(dur);
Â  Â  Â  }
Â  Â  }
Â  Â  function cerrarModal(){ document.getElementById("modalHorario").style.display="none"; }

Â  Â  async function obtenerClaseExacta(td){
Â  Â  Â  const prefijo = `${fechaSabadoISO}_sabado_${td.dataset.hora}_`;
Â  Â  Â  for (const id in datosExtra){ if (id.startsWith(prefijo)) return datosExtra[id]; }
Â  Â  Â  return null;
Â  Â  }

Â  Â  async function guardarHorarioModal(){
Â  Â  Â  const ciclo = document.getElementById("inputCiclo").value.trim();
Â  Â  Â  const asigSel = document.getElementById("inputAsignatura").value;
Â  Â  Â  const profesor = document.getElementById("inputProfesorAuto").value.trim();
Â  Â  Â  const duracion = Number(document.getElementById("inputDuracion").value);

Â  Â  Â  if (!ciclo){ alert("Selecciona el ciclo."); return; }
Â  Â  Â  if (!asigSel){ alert("Selecciona la asignatura."); return; }
Â  Â  Â  if (!profesor){ alert("No hay docente asociado a la asignatura en este ciclo."); return; }
Â  Â  Â  if (duracion<1 || duracion>4){ alert("DuraciÃ³n invÃ¡lida (1 a 4 horas)."); return; }
      
      // Eliminar el bloque que se sobreescribe para evitar conflictos
      await eliminarHorarioModal(true); 

Â  Â  Â  const dia="sabado";
Â  Â  Â  const horaInicio=celdaEnEdicion.dataset.hora;
Â  Â  Â  const horaFin=sumarHoras(horaInicio,duracion);
Â  Â  Â  const docId=`${fechaSabadoISO}_${dia}_${horaInicio}_${horaFin}`;

Â  Â  Â  await db.collection("horario_extra").doc(docId).set({
Â  Â  Â  Â  fecha: fechaSabadoISO,
Â  Â  Â  Â  dia,
Â  Â  Â  Â  hora: horaInicio,
Â  Â  Â  Â  hora_fin: horaFin,
Â  Â  Â  Â  duracion,
Â  Â  Â  Â  asignatura: asigSel.toUpperCase(),
Â  Â  Â  Â  profesor,
Â  Â  Â  Â  ciclo
Â  Â  Â  });

Â  Â  Â  cerrarModal();
Â  Â  Â  cargarTabla();
Â  Â  }

Â  Â  async function eliminarHorarioModal(suppressAlert = false){
Â  Â  Â  if (!celdaEnEdicion) return;
Â  Â  Â  const prefijo=`${fechaSabadoISO}_sabado_${celdaEnEdicion.dataset.hora}_`;
Â  Â  Â  
Â  Â  Â  let idAEliminar=null;
Â  Â  Â  for (const id in datosExtra){ 
          // Buscar un bloque cuya hora de inicio sea EXACTAMENTE la hora de la celda
          if (id.startsWith(prefijo)) { 
              idAEliminar=id; break; 
          }
          // TambiÃ©n debe buscar si esta celda es parte de un bloque mÃ¡s grande que inicia antes
          const b = datosExtra[id];
          const inicio=convertirHoraANum(b.hora), fin=convertirHoraANum(b.hora_fin), hnum=convertirHoraANum(celdaEnEdicion.dataset.hora);
          if (hnum > inicio && hnum < fin){
              // Si la celda actual estÃ¡ dentro de un bloque, debe eliminar el bloque completo
              if (confirm(`La celda (${celdaEnEdicion.dataset.hora}) es parte de un bloque que comienza a las ${b.hora}. Â¿Deseas eliminar el bloque completo?`)){
                   idAEliminar = id; break;
              } else {
                   return; // Cancelar
              }
          }
      }

Â  Â  Â  if (idAEliminar){
Â  Â  Â  Â  await db.collection("horario_extra").doc(idAEliminar).delete();
Â  Â  Â  Â  if (!suppressAlert) {
            cerrarModal(); 
            cargarTabla();
        }
Â  Â  Â  }else if (!suppressAlert) {
Â  Â  Â  Â  alert("No se encontrÃ³ un bloque exacto a esa hora para eliminar.");
Â  Â  Â  }
Â  Â  }

Â  Â  // ---------- Clases predefinidas (reutiliza tu colecciÃ³n) ----------
Â  Â  async function precargarClasesCiclo(ciclo){
Â  Â  Â  if (clasesPorCiclo[ciclo]) return;
Â  Â  Â  const arr=[];
Â  Â  Â  const snap=await db.collection("clases_definidas").where("ciclo","==",ciclo).get();
Â  Â  Â  snap.forEach(d=>{
Â  Â  Â  Â  const data=d.data();
Â  Â  Â  Â  arr.push({ asignatura:(data.asignatura||"").toUpperCase(), profesor:data.profesor||"" });
Â  Â  Â  });
Â  Â  Â  clasesPorCiclo[ciclo]=arr;
Â  Â  }

Â  Â  async function actualizarOpcionesAsignaturas(){
Â  Â  Â  const ciclo=document.getElementById("inputCiclo").value.trim();
Â  Â  Â  const sel=document.getElementById("inputAsignatura");
Â  Â  Â  sel.innerHTML=`<option value="">Selecciona asignatura...</option>`;
Â  Â  Â  document.getElementById("inputProfesorAuto").value="";

Â  Â  Â  if (!ciclo) return;
Â  Â  Â  await precargarClasesCiclo(ciclo);
Â  Â  Â  const lista=clasesPorCiclo[ciclo]||[];

Â  Â  Â  const setAsig=new Set(); lista.forEach(it=>{ if(it.asignatura) setAsig.add(it.asignatura.toUpperCase()); });
Â  Â  Â  [...setAsig].sort().forEach(asig=>{
Â  Â  Â  Â  sel.insertAdjacentHTML("beforeend", `<option value="${asig}">${asig}</option>`);
Â  Â  Â  });
Â  Â  }

Â  Â  async function actualizarDocenteAuto(){
Â  Â  Â  const ciclo=document.getElementById("inputCiclo").value.trim();
Â  Â  Â  const asig=document.getElementById("inputAsignatura").value;
Â  Â  Â  const out=document.getElementById("inputProfesorAuto");
Â  Â  Â  out.value="";
Â  Â  Â  if (!ciclo || !asig) return;

Â  Â  Â  await precargarClasesCiclo(ciclo);
Â  Â  Â  const lista=clasesPorCiclo[ciclo]||[];
Â  Â  Â  const found=lista.find(it=>(it.asignatura||"").toUpperCase()===asig.toUpperCase());
Â  Â  Â  if (found) out.value=found.profesor||"";
Â  Â  }


    // ==========================================================
    // ğŸ”‘ BLOQUE DE SEGURIDAD: AUTENTICACIÃ“N Y AUTORIZACIÃ“N 
    // ==========================================================
    auth.onAuthStateChanged(async (user) => {
        
        // 1. Si NO hay usuario logueado, redirigir al login
        if (!user) {
            window.location.href = "login.html"; 
            return;
        }

        // 2. Usuario logueado: Verificar si su UID existe en la colecciÃ³n 'supervisores'
        try {
            const userUid = user.uid;
            const supervisorDoc = await db.collection("supervisores").doc(userUid).get();

            if (supervisorDoc.exists) {
                // ğŸ”‘ ACCESO CONCEDIDO
                console.log("Supervisor autorizado. Iniciando interfaz.");
                // Llama a la funciÃ³n principal para inicializar la UI
                inicializarUI(); 
                
            } else {
                // Acceso denegado: Logueado, pero no es supervisor
                alert("Acceso denegado. No tienes permisos de supervisor.");
                auth.signOut(); // Desloguear
                window.location.href = "login.html";
            }

        } catch (error) {
            console.error("Error verificando supervisor:", error);
            alert("OcurriÃ³ un error en la verificaciÃ³n de seguridad.");
            auth.signOut();
            window.location.href = "login.html";
        }
    });

Â  </script>
</body>
</html>
