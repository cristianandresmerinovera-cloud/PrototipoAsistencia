<!DOCTYPE html>
<html lang="es">
<head>
  <link rel="icon" href="icono-app.png" type="image/png" />
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#2563eb" />
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Escaneo de Asistencia</title>

  <!-- Librer√≠as -->
  <script src="https://unpkg.com/html5-qrcode"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>

  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f1f5f9;
      text-align: center;
    }
    header {
      background-color: #1e3a8a;
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 20px;
      border-bottom: 4px solid #2563eb;
      flex-wrap: wrap;
      gap: 10px;
    }
    header img { height: 60px; flex-shrink: 0; }
    header h2 { margin: 0; font-size: 20px; font-weight: 600; flex-grow: 1; text-align: center; min-width: 200px; }
    .userbar { display:flex; align-items:center; gap:8px; }
    .userbar button { background:#2563eb; border:0; color:#fff; padding:6px 10px; border-radius:8px; cursor:pointer; font-size:14px; }
    .userbar .plain { background:#0ea5e9; }
    .userbar .danger { background:#ef4444; }
    main { padding: 20px; max-width: 520px; margin: 0 auto; }
    .titulo-centro { color: #1e3a8a; font-weight: bold; font-size: 24px; margin-bottom: 25px; }

    .botones-container { display: flex; justify-content: center; gap: 24px; flex-wrap: wrap; margin-bottom: 30px; }
    .boton-imagen { display: flex; flex-direction: column; align-items: center; cursor: pointer; transition: transform 0.3s ease; background: white; padding: 10px; border-radius: 12px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); width: 140px; user-select: none; }
    .boton-imagen:hover { transform: scale(1.06); }
    .boton-imagen img { width: 100px; height: 100px; object-fit: contain; margin-bottom: 10px; }
    .boton-imagen span { font-weight: 600; color: #1e3a8a; text-wrap: balance; text-align:center; }

    #practicasForm { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); max-width: 400px; margin: 0 auto 30px; display: none; text-align: left; }
    #practicasForm label { display: block; margin-bottom: 8px; font-weight: 600; color: #1e3a8a; }
    #practicasForm select, #practicasForm input { width: 100%; padding: 8px 10px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 6px; font-size: 16px; }
    #practicasForm button { background-color: #2563eb; border: none; color: white; padding: 10px 15px; margin-right: 10px; border-radius: 8px; font-size: 16px; cursor: pointer; transition: background-color 0.3s ease; }
    #practicasForm button:hover { background-color: #1e40af; }

    #seccion-escaner { max-width: 520px; margin: 0 auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); display: none; }
    #seccion-escaner h3 { color: #1e3a8a; margin-bottom: 15px; }
    #reader { margin: 0 auto; width: 100%; max-width: 320px; }
    #seccion-escaner button { margin-top: 20px; background-color: #ef4444; border: none; color: white; padding: 10px 25px; border-radius: 8px; font-size: 16px; cursor: pointer; transition: background-color 0.3s ease; }
    #seccion-escaner button:hover { background-color: #b91c1c; }

    #seccion-uso-libre { display:none; }
    .grid { display:grid; grid-template-columns:1fr; gap:10px; }
    .card-eq { background:#fff; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,.12); padding:12px; text-align:left; display:flex; justify-content:space-between; align-items:center; gap:8px; }
    .eq-info { font-size:14px; color:#1f2937; }
    .eq-info b { color:#111827; }
    .pill { padding:4px 8px; border-radius:999px; font-size:12px; font-weight:600; }
    .pill.libre { background:#ecfdf5; color:#065f46; }
    .pill.reservado { background:#fff7ed; color:#92400e; }
    .pill.enuso { background:#eff6ff; color:#1d4ed8; }
    .pill.mant { background:#fee2e2; color:#991b1b; }
    .btn-sm { background:#2563eb; color:#fff; border:0; border-radius:8px; padding:8px 10px; cursor:pointer; font-size:14px; }
    .btn-sm[disabled]{ opacity:.5; cursor:not-allowed; }
    .toolbar { display:flex; gap:8px; align-items:center; margin:10px 0 16px; }
    .toolbar input[type="date"], .search { padding:8px 10px; border:1px solid #cbd5e1; border-radius:8px; font-size:14px; }
    .search { width:100%; }

    #modal-scan { position:fixed; inset:0; background:rgba(0,0,0,.45); display:none; align-items:center; justify-content:center; padding:16px; z-index:50; }
    .box { background:#fff; border-radius:14px; max-width:540px; width:100%; padding:16px; box-shadow:0 10px 30px rgba(0,0,0,.2) }
    .box h4 { margin:0 0 10px; color:#1e3a8a; }
    .muted { color:#6b7280; font-size:14px; }
    .row { display:flex; gap:10px; align-items:center; justify-content:space-between; }

    /* Modales simples */
    .overlay { position:fixed; inset:0; background:rgba(0,0,0,.45); display:none; align-items:center; justify-content:center; padding:16px; z-index:60; }
    .panel { background:#fff; border-radius:14px; max-width:540px; width:100%; padding:16px; box-shadow:0 10px 30px rgba(0,0,0,.2) }

    .input { width:100%; padding:10px; border:1px solid #cbd5e1; border-radius:8px; font-size:14px; }
    .rowg { display:flex; gap:8px; align-items:center; }
    .btn { background:#2563eb; color:#fff; border:0; border-radius:8px; padding:10px 14px; cursor:pointer; font-size:14px; }
    .btn.secondary { background:#6b7280; }
    .list { text-align:left; font-size:14px; max-height:240px; overflow:auto; border:1px solid #e5e7eb; border-radius:10px; padding:8px; }

    @media (max-width: 520px) {
      .botones-container { gap: 15px; }
      .boton-imagen { width: 46vw; padding: 8px; }
      .boton-imagen img { width: 80px; height: 80px; }
      #seccion-escaner, #practicasForm { width: 95vw; padding: 15px; }
      #reader { max-width: 100%; width: 100% !important; }
    }
    @media (max-width: 480px) {
      header { justify-content: center; }
      header img { height: 50px; }
      header h2 { font-size: 18px; min-width: auto; flex-basis: 100%; text-align: center; margin-top: 5px; }
    }
    
  </style>
</head>
<body>

<header>
  <img src="logounl.png" alt="Logo UNL" />
  <h2>REGISTRO DE ASISTENCIA Y GESTI√ìN DE LABORATORIO</h2>
  <div class="userbar">
    <span id="userLabel" style="font-size:12px;opacity:.9"></span>
    <button id="btnLogin" class="plain" onclick="abrirLogin()">Iniciar sesi√≥n</button>
    <button id="btnPerfil" style="display:none" onclick="abrirPerfil()">Mi perfil</button>
    <button id="btnLogout" class="danger" style="display:none" onclick="logout()">Salir</button>
  </div>
  <img src="logocit.png" alt="Logo CIT" />
</header>

<main>
  <h3 class="titulo-centro">Bienvenido al sistema de control y asistencia</h3>

  <!-- Menu -->
  <div id="tipoAsistenciaContainer" class="botones-container">
    <div class="boton-imagen" onclick="iniciarEscanerConTipo('clase')">
      <img src="icono-clases.png" alt="Asistencia a Clases" />
      <span>Asistencia a Clases</span>
    </div>
    <div class="boton-imagen" onclick="iniciarUsoPorReserva()">
      <img src="icono-laboratorio.png" alt="Uso Libre" />
      <span>Uso Libre</span>
    </div>
    <div class="boton-imagen" onclick="mostrarFormularioPracticas()">
      <img src="icono-practicas.png" alt="Pr√°cticas" />
      <span>Pr√°cticas Acad√©micas</span>
    </div>
    <div class="boton-imagen" onclick="abrirFicha()">
  <img src="logoficha.png" alt="Ficha y asistencia del Estudiante" />
  <span>Ver mis asistencias</span>
</div>

  </div>

  <!-- Formulario pr√°cticas -->
  <div id="practicasForm">
    <label for="preparatorio">¬øEs preparatorio?</label>
    <select id="preparatorio">
      <option value="NO">NO</option>
      <option value="S√ç">S√ç</option>
    </select>

    <label for="grupo">Grupo (opcional)</label>
    <input type="text" id="grupo" placeholder="Ej: 1, 2, 3..." />

    <div style="text-align: center;">
      <button onclick="continuarConPractica()">Continuar</button>
      <button class="secondary" onclick="cancelar()">Cancelar</button>
    </div>
  </div>

  <!-- Uso Libre -->
  <div id="seccion-uso-libre">
    <h3>Selecciona tu equipo reservado</h3>
    <div class="toolbar">
      <input id="fechaConsulta" type="date" />
      <input id="buscaEquipo" class="search" type="text" placeholder="Buscar: c√≥digo, nombre, marca o modelo‚Ä¶" />
    </div>
    <div id="gridEquipos" class="grid"></div>
    <div style="margin-top:10px">
      <button class="btn" onclick="volverMenu()">Volver</button>
    </div>
  </div>

  <!-- Esc√°ner (clases/pr√°cticas) -->
  <div id="seccion-escaner">
    <h3>Escanea tu c√≥digo QR</h3>
    <div id="reader"></div>
    <button onclick="cancelar()">Cancelar</button>
  </div>

  <!-- Modal Uso Libre -->
  <div id="modal-scan">
    <div class="box">
      <h4 id="scanTitulo">Confirmar uso</h4>
      <p class="muted" id="scanSub">Estudiante asignado: <b id="scanEst"></b>. Por favor, escanee su QR para iniciar el uso.</p>
      <div id="readerModal"></div>
      <div class="row" style="margin-top:10px">
        <span class="muted" id="scanVentana"></span>
        <button class="btn" onclick="cerrarModal()">Cancelar</button>
      </div>
    </div>
  </div>
</main>

<!-- ====== Modal Login ====== -->
<div id="loginOverlay" class="overlay">
  <div class="panel">
    <h3 style="margin:0 0 8px">Acceder</h3>
    <p class="muted" style="margin:0 0 12px">
      Usa tu <b>correo institucional</b>. Si es tu primera vez, podr√°s registrarte.
    </p>
    <input id="loginEmail" class="input" type="email" placeholder="correo institucional" style="width:60%;" />
    <input id="loginPass" class="input" type="password" placeholder="contrase√±a" style="width:60%; margin-top:8px;" />
    <div class="rowg" style="margin-top:10px; flex-wrap:wrap;">
      <button class="btn" onclick="doLogin()">Entrar</button>
      <button class="btn secondary" onclick="abrirRegistro()">Registrarme</button>
      <button class="btn secondary" onclick="recuperarPass()">Olvid√© mi contrase√±a</button>
      <button class="btn danger" onclick="cerrarLogin()">Cerrar</button>
    </div>
  </div>
</div>

<!-- ====== Modal Registro (solo alumnos) ====== -->
<div id="regOverlay" class="overlay">
  <div class="panel">
    <h3 style="margin:0 0 8px">Registro de alumno</h3>
    <p class="muted" style="margin:0 0 12px">
      Se validar√° contra tu registro en <b>estudiantes</b>.
    </p>
    <input id="regEmail" class="input" type="email" placeholder="correo" style="width:60%;" />
    <input id="regPass" class="input" type="password" placeholder="contrase√±a (m√≠n. 6)" style="width:60%; margin-top:8px;" />
    <p class="muted" style="margin:10px 0 6px">
      Escanea tu propio QR para confirmar identidad:
    </p>
    <div id="readerReg" style="max-width:320px;margin:0 auto 8px"></div>
    <div class="rowg">
      <button class="btn" onclick="doRegistro()">Crear cuenta</button>
      <button class="btn secondary" onclick="cerrarRegistro()">Cerrar</button>
    </div>
  </div>
</div>

<!-- ====== Modal Perfil ====== -->
<div id="perfilOverlay" class="overlay">
  <div class="panel" id="perfilPanel">
    <h3 style="margin:0 0 8px">Mi perfil</h3>
    <div id="perfilContent" style="text-align:left;font-size:14px"></div>
    <div style="margin-top:10px">
      <label class="btn">
        Cambiar foto
        <input id="fotoInput" type="file" accept="image/*" style="display:none">
      </label>
      <button class="btn secondary" onclick="cerrarPerfil()">Cerrar</button>
    </div>
    <div style="margin-top:14px">
      <h4 style="margin:0 0 6px">Mis asistencias</h4>
      <div id="misAsist" class="list"></div>
    </div>
  </div>
</div>

<script>
  /* ===================== Firebase ===================== */
  const firebaseConfig = {
    apiKey: "AIzaSyBByttCwTn1hMwo9X5P2gbsYlSq9lGa7t0",
    authDomain: "escaner-qr-d7d65.firebaseapp.com",
    projectId: "escaner-qr-d7d65",
    storageBucket: "escaner-qr-d7d65.appspot.com",
    messagingSenderId: "982923527298",
    appId: "1:982923527298:web:df13850f38d847cfdae09b"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const auth = firebase.auth();

  /* ===================== Estado ===================== */
  let tipoAsistenciaSeleccionado = null;
  let datosPractica = { preparatorio: "", grupo: "" };
  let scanner = null;
  let scannerModal = null;
  let scannerReg = null; // esc√°ner para registro

  // Uso libre
  let equiposCache = [];
  let reservasHoy = [];
  let reservasConsulta = [];
  let usosActivos = new Set();
  let equipoClickActual = null;
  let reservaParaEquipo = null;

  let reservasHoyUnsub = null;
  let reservasConsultaUnsub = null;

  // Sesi√≥n/rol
  let miCedula = localStorage.getItem('miCedula') || null;


  
  /* ===================== Utils ===================== */
  const pad = n => String(n).padStart(2, "0");
¬† 
¬† // *** FUNCI√ìN CORREGIDA para usar la fecha local ***
¬† function hoyStr(){
¬†   const d = new Date();
¬†   return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
¬† }
¬† 
¬† const $ = sel => document.querySelector(sel);

  function norm(s){ return (s||"").toString().toLowerCase().normalize("NFD").replace(/\p{Diacritic}/gu,""); }
 /* ===================== validar asignatura matriculada ===================== */
  async function validarAsignaturaEstudiante(cedula, asignaturaActual) {
  const ref = db.collection("estudiantes").doc(cedula);
  const snap = await ref.get();
  if (!snap.exists) return { ok:false, motivo:"Estudiante no encontrado" };

  const data = snap.data();

  // Normalizar para evitar errores por tildes/may√∫sculas
  const asignaturaNorm = norm(asignaturaActual);

  const tiene = (data.asignaciones || []).some(a => {
    return norm(a.asignatura) === asignaturaNorm;
  });

  if (tiene) {
    return { ok:true };
  } else {
    return { 
      ok:false, 
      motivo: `‚ö†Ô∏è No est√°s matriculado en la asignatura "${asignaturaActual}". Si crees que es un error, ac√©rcate al encargado del laboratorio para que te asigne esta materia.` 
    };
  }
}
  function inRangeNowByDate(reserva) {
    const [y,m,d] = reserva.fecha.split("-").map(Number);
    const [sh, sm] = reserva.hora_inicio.split(":").map(Number);
    const [eh, em] = reserva.hora_fin.split(":").map(Number);
    const start = new Date(y, m-1, d, sh, sm || 0, 0, 0);
    const end   = new Date(y, m-1, d, eh, em || 0, 0, 0);
    const now   = new Date();
    return (now.getTime() + 2*60*1000) >= start.getTime() && now < end;
  }

  // Device binding (opci√≥n 2)
  function getOrCreateDeviceId(){
    let id = localStorage.getItem('deviceId');
    if (!id) { id = self.crypto?.randomUUID ? crypto.randomUUID() : (Date.now()+"-"+Math.random().toString(16).slice(2)); localStorage.setItem('deviceId', id); }
    return id;
  }

  async function asegurarVinculoDispositivo(cedula){
    const deviceId = getOrCreateDeviceId();
    const ref = db.collection("estudiantes").doc(cedula);
    const snap = await ref.get();
    if (!snap.exists) throw new Error("Estudiante no encontrado");
    const data = snap.data();
    if (!data.deviceId) {
      await ref.update({ deviceId });
      return true;
    }
    if (data.deviceId !== deviceId) {
      alert("‚ùå Este usuario ya est√° vinculado a otro dispositivo.");
      return false;
    }
    return true;
  }

  function extraerCedulaDesdeQR(qrTexto) {
    try {
      const url = new URL(qrTexto);
      const base64 = url.searchParams.get("q");
      if (!base64) return null;
      return atob(base64);
    } catch { return null; }
  }

  function calcularDistanciaMetros(lat1, lon1, lat2, lon2) {
    const R = 6371e3;
    const œÜ1 = lat1 * Math.PI / 180, œÜ2 = lat2 * Math.PI / 180;
    const ŒîœÜ = (lat2 - lat1) * Math.PI / 180, ŒîŒª = (lon2 - lon1) * Math.PI / 180;
    const a = Math.sin(ŒîœÜ/2)**2 + Math.cos(œÜ1)*Math.cos(œÜ2)*Math.sin(ŒîŒª/2)**2;
    return 2 * R * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  }

  /* ===================== UI B√°sica Sesi√≥n ===================== */
  function setUserBar(user, labelExtra=""){
    const lbl = $("#userLabel");
    const bLogin = $("#btnLogin"), bPerfil = $("#btnPerfil"), bLogout = $("#btnLogout");
    if (user) {
      bLogin.style.display = "none";
      bPerfil.style.display = "inline-block";
      bLogout.style.display = "inline-block";
     lbl.textContent = "Alumno" + (user.email? (" ¬∑ " + user.email) : "") + labelExtra;
    } else {
      bLogin.style.display = "inline-block";
      bPerfil.style.display = "none";
      bLogout.style.display = "none";
      lbl.textContent = "";
    }
  }

  function abrirLogin(){ $("#loginOverlay").style.display='flex'; }
  function cerrarLogin(){ $("#loginOverlay").style.display='none'; }
  function abrirRegistro(){
    cerrarLogin();
    $("#regOverlay").style.display='flex';
    // arrancar esc√°ner para confirmar identidad (QR propio)
    if (scannerReg) { scannerReg.clear().catch(()=>{}); scannerReg=null; }
    scannerReg = new Html5QrcodeScanner("readerReg", { fps:10, qrbox: 220 });
    scannerReg.render((txt)=>{ const c = extraerCedulaDesdeQR(txt); if (c) { localStorage.setItem('cedulaRegistro', c); alert("‚úÖ QR le√≠do: " + c); if (scannerReg){scannerReg.clear();scannerReg=null;} } else { alert("‚ö†Ô∏è QR inv√°lido"); } });
  }
  function cerrarRegistro(){
    $("#regOverlay").style.display='none';
    if (scannerReg){ scannerReg.clear().catch(()=>{}); scannerReg=null; }
  }
  function abrirPerfil(){ cargarPerfil(); $("#perfilOverlay").style.display='flex'; }
  function cerrarPerfil(){ $("#perfilOverlay").style.display='none'; }

  /* ===================== Auth ===================== */
  
  async function doLogin(){
    const email = $("#loginEmail").value.trim().toLowerCase();
    const pass = $("#loginPass").value;
    try{
      const cred = await auth.signInWithEmailAndPassword(email, pass);

    // Si a√∫n no tiene miCedula en local, pedirle que la vincule (una sola vez)
    if (!miCedula) {
  alert("Para continuar, abre 'Mi perfil' y vincula tu identidad si a√∫n no lo hiciste (Registr√°ndote si es la primera vez).");
}

      setUserBar(cred.user);
      cerrarLogin();
    }catch(e){ alert("‚ùå " + e.message); }
  }

  async function doRegistro(){
    const email = $("#regEmail").value.trim().toLowerCase();
    const pass = $("#regPass").value;
    const cedula = localStorage.getItem('cedulaRegistro');
    if (!cedula) { alert("Escanea tu QR para confirmar tu c√©dula."); return; }

    try{
      // Validar contra estudiantes
      const est = await db.collection("estudiantes").doc(cedula).get();
      if (!est.exists) { alert("‚ùå Estudiante no encontrado"); return; }
      const datos = est.data();
      if ((datos.correo_institucional||"").trim().toLowerCase() !== email) {
        alert("‚ùå El correo no coincide con el registrado en estudiantes");
        return;
      }

      // Crear cuenta
      const cred = await auth.createUserWithEmailAndPassword(email, pass);

      // Vincular identidad local
      miCedula = cedula;
      localStorage.setItem('miCedula', miCedula);

      // Vincular dispositivo
      const ok = await asegurarVinculoDispositivo(miCedula);
      if (!ok) { await auth.signOut(); miCedula=null; localStorage.removeItem('miCedula'); return; }

      setUserBar(cred.user, " ¬∑ vinculado a " + miCedula);
      cerrarRegistro();
      alert("‚úÖ Cuenta creada y dispositivo vinculado.");
    }catch(e){ alert("‚ùå " + e.message); }
  }

  async function recuperarPass(){
    const email = $("#loginEmail").value.trim().toLowerCase();
    if (!email) return alert("Ingresa tu correo institucional y luego presiona 'Olvid√© mi contrase√±a'");
    try{ await auth.sendPasswordResetEmail(email); alert("üìß Revisa tu correo para restablecer la contrase√±a."); }
    catch(e){ alert("‚ùå " + e.message); }
  }

async function logout(){
  await auth.signOut();
  setUserBar(null);
}


auth.onAuthStateChanged((user)=>{
  if (!user) { setUserBar(null); return; }
  setUserBar(user, miCedula ? (" ¬∑ " + miCedula) : "");
});



  /* ===================== Navegaci√≥n ===================== */
  function mostrarSeccion(seccion) {
    $("#tipoAsistenciaContainer").style.display = "none";
    $("#seccion-escaner").style.display = "none";
    $("#practicasForm").style.display = "none";
    $("#seccion-uso-libre").style.display = "none";
    $("#modal-scan").style.display = "none";

    if (seccion === "menu") $("#tipoAsistenciaContainer").style.display = "flex";
    if (seccion === "escaner") {
      $("#seccion-escaner").style.display = "block";
      try { iniciarEscaner(); } catch(e) { console.warn(e); }
    }
    if (seccion === "practica") $("#practicasForm").style.display = "block";
    if (seccion === "uso") $("#seccion-uso-libre").style.display = "block";
  }
  function volverMenu(){
    if (typeof reservasHoyUnsub === "function") reservasHoyUnsub();
    if (typeof reservasConsultaUnsub === "function") reservasConsultaUnsub();
    reservasHoyUnsub = null; reservasConsultaUnsub = null;
    mostrarSeccion("menu");
  }
function abrirFicha(){
  if (!auth.currentUser) {
    alert("üîê Debes iniciar sesi√≥n para ver tu ficha.");
    abrirLogin();
    return;
  }
  if (!miCedula) {
    alert("‚ö†Ô∏è No tienes tu c√©dula vinculada. Escanea tu QR desde 'Registrarme' en el login.");
    return;
  }
  window.open('perfil-estudiante.html?cedula=' + encodeURIComponent(miCedula), '_blank');
}

  /* ===================== Flujos originales ===================== */
  function iniciarEscanerConTipo(tipo) {
    // Si es CLASE o PR√ÅCTICA ‚Üí exigir login (Uso Libre queda libre)
    if ((tipo === 'clase' || tipo === 'practica') && !auth.currentUser) {
      alert("üîê Inicia sesi√≥n para registrar asistencia.");
      abrirLogin();
      return;
    }
    validarRedYUbicacionAntesDeEscanear(tipo);
  }

  function mostrarFormularioPracticas() {
    tipoAsistenciaSeleccionado = "practica";
    mostrarSeccion("practica");
  }

  function continuarConPractica() {
    datosPractica.preparatorio = document.getElementById("preparatorio").value;
    datosPractica.grupo = document.getElementById("grupo").value;
    if (!auth.currentUser) { alert("üîê Inicia sesi√≥n para registrar asistencia."); abrirLogin(); return; }
    validarRedYUbicacionAntesDeEscanear("practica");
  }

  function cancelar() {
    tipoAsistenciaSeleccionado = null;
    datosPractica = { preparatorio: "", grupo: "" };
    if (scanner) { scanner.clear().catch(()=>{}); scanner = null; }
    if (scannerModal) { scannerModal.clear().catch(()=>{}); scannerModal = null; }
    if (scannerReg) { scannerReg.clear().catch(()=>{}); scannerReg = null; }
    if (typeof reservasHoyUnsub === "function") reservasHoyUnsub();
    if (typeof reservasConsultaUnsub === "function") reservasConsultaUnsub();
    reservasHoyUnsub = null; reservasConsultaUnsub = null;
    mostrarSeccion("menu");
  }

  
  
 

  /* ===================== USO LIBRE (sin cambios de auth/binding) ===================== */
  function iniciarUsoPorReserva(){
    tipoAsistenciaSeleccionado = "uso_reserva";
    const f = document.getElementById("fechaConsulta");
    f.value = hoyStr();
    listenReservasHoy();
    listenReservasConsulta(f.value);
    mostrarSeccion("uso");
    renderEquiposGrid();
  }
  db.collection("equipos").onSnapshot(snap=>{ equiposCache = snap.docs.map(d=>d.data()); renderEquiposGrid(); });
  db.collection("usos").where("activo","==",true).onSnapshot(snap=>{ const set=new Set(); snap.forEach(d=>{ const u=d.data(); if (u.id_equipo) set.add(u.id_equipo); }); usosActivos=set; renderEquiposGrid(); });
  function listenReservasHoy(){ if (typeof reservasHoyUnsub === "function") reservasHoyUnsub(); reservasHoyUnsub = db.collection("reservas").where("fecha","==", hoyStr()).onSnapshot(s=>{ reservasHoy = s.docs.map(d=>({id:d.id, ...d.data()})); renderEquiposGrid(); }); }
  function listenReservasConsulta(fechaStr){ if (typeof reservasConsultaUnsub === "function") reservasConsultaUnsub(); reservasConsultaUnsub = db.collection("reservas").where("fecha","==", fechaStr).onSnapshot(s=>{ reservasConsulta = s.docs.map(d=>({id:d.id, ...d.data()})); renderEquiposGrid(); }); }
  const grid = document.getElementById("gridEquipos");
  const fechaConsulta = document.getElementById("fechaConsulta");
  const buscaEquipo = document.getElementById("buscaEquipo");
  fechaConsulta.addEventListener("change", ()=>{ listenReservasConsulta(fechaConsulta.value || hoyStr()); });
  buscaEquipo.addEventListener("input", renderEquiposGrid);

  function renderEquiposGrid(){
    if (document.getElementById("seccion-uso-libre").style.display !== "block") return;
    const fConsulta = fechaConsulta.value || hoyStr();
    const q = (buscaEquipo.value||"").toLowerCase();
    grid.innerHTML = "";
    const equiposFiltrados = equiposCache.filter(e => !q || [e.codigo,e.nombre,e.marca,e.modelo].some(v => (v||"").toLowerCase().includes(q)));
    if (!equiposFiltrados.length){ grid.innerHTML = `<div class="muted">No hay equipos que coincidan con la b√∫squeda.</div>`; return; }
    equiposFiltrados.forEach(e=>{
      const estadoBase = usosActivos.has(e.codigo) ? "en_uso" : (e.estado === "mantenimiento") ? "mantenimiento" : (e.estado === "reservado") ? "reservado" : "libre";
      const reservasEquipoConsulta = reservasConsulta.filter(r => r.id_equipo === e.codigo);
      const reservasEquipoHoy = reservasHoy.filter(r => r.id_equipo === e.codigo);
      const activaHoy = reservasEquipoHoy.find(inRangeNowByDate);
      const pillCls = estadoBase==="en_uso" ? "enuso" : estadoBase==="mantenimiento" ? "mant" : estadoBase==="reservado" ? "reservado" : "libre";
      const pillText = estadoBase.replace("_"," ");
      const card = document.createElement("div"); card.className = "card-eq";
      const left = document.createElement("div"); left.className = "eq-info";
      left.innerHTML = `
        <div><b>${e.codigo}</b> ‚Äî ${e.nombre} ${e.marca} ${e.modelo}</div>
        <div style="font-size:13px;color:#475569">Serie: ${e.serie || "-"}</div>
        ${ reservasEquipoConsulta.length
            ? `<div class="muted" style="font-size:12px;margin-top:4px">
                 ${fConsulta === hoyStr() ? "Reservas de hoy:" : `Reservas del ${fConsulta}:`}
                 ${reservasEquipoConsulta.map(rr => `${rr.hora_inicio}-${rr.hora_fin} (${rr.nombre_estudiante})`).join(" ‚Ä¢ ")}
               </div>`
            : `<div class="muted" style="font-size:12px;margin-top:4px">Sin reservas para ${fConsulta}.</div>`
        }`;
      const right = document.createElement("div"); right.style.display="flex"; right.style.flexDirection="column"; right.style.gap="6px";
      const pill = document.createElement("span"); pill.className = "pill " + pillCls; pill.textContent = pillText;
      const btn = document.createElement("button"); btn.className = "btn-sm";
      if (activaHoy && estadoBase !== "en_uso" && estadoBase !== "mantenimiento"){
        btn.disabled = false; btn.textContent = `Reservado ahora: ${activaHoy.nombre_estudiante} (Iniciar)`; btn.onclick = ()=> abrirModalScan(e, activaHoy);
      } else { btn.disabled = true; btn.textContent = estadoBase==="en_uso"?"En uso":(estadoBase==="mantenimiento"?"Mantenimiento":"Fuera de horario (no iniciable)"); }
      right.appendChild(pill); right.appendChild(btn);
      card.appendChild(left); card.appendChild(right); grid.appendChild(card);
    });
  }

  function abrirModalScan(equipo, reservaHoyActiva){
    equipoClickActual = equipo; reservaParaEquipo = reservaHoyActiva;
    document.getElementById("scanTitulo").textContent = `Iniciar uso: ${equipo.codigo} ‚Äî ${equipo.nombre} ${equipo.marca} ${equipo.modelo}`;
    document.getElementById("scanEst").textContent = `${reservaHoyActiva.nombre_estudiante} (${reservaHoyActiva.cedula_estudiante})`;
    document.getElementById("scanVentana").textContent = `Ventana: ${reservaHoyActiva.hora_inicio}‚Äì${reservaHoyActiva.hora_fin} (HOY)`;
    document.getElementById("modal-scan").style.display = "flex";
    iniciarEscanerModal();
  }
  function cerrarModal(){
    if (scannerModal){ scannerModal.clear().catch(()=>{}); scannerModal=null; }
    document.getElementById("modal-scan").style.display = "none";
    equipoClickActual = null; reservaParaEquipo = null;
  }
  function iniciarEscanerModal(){
    if (scannerModal){ scannerModal.clear().catch(()=>{}); scannerModal = null; }
    scannerModal = new Html5QrcodeScanner("readerModal", { fps: 10, qrbox: 250 });
    scannerModal.render(handleQRReserva);
  }
  async function handleQRReserva(decodedText){
    if (scannerModal){ await scannerModal.clear().catch(()=>{}); scannerModal=null; }
    const cedula = extraerCedulaDesdeQR(decodedText);
    if (!cedula){ alert("‚ö†Ô∏è QR inv√°lido"); cerrarModal(); return; }
    const eq = equipoClickActual, r = reservaParaEquipo;
    if (!eq || !r){ alert("‚ö†Ô∏è No se pudo determinar equipo/reserva."); cerrarModal(); return; }
    if (!inRangeNowByDate(r)) { alert("‚ùå La reserva no est√° activa en este momento."); cerrarModal(); return; }
    if (cedula !== r.cedula_estudiante) { alert("‚ùå QR distinto al estudiante asignado."); cerrarModal(); return; }

    try{
      await db.runTransaction(async (tx)=>{
        const eqRef = db.collection("equipos").doc(eq.codigo);
        const eqSnap = await tx.get(eqRef);
        if (!eqSnap.exists) throw new Error("Equipo no encontrado.");
        const usoActivoSnap = await db.collection("usos").where("id_equipo","==", eq.codigo).where("activo","==", true).get();
        if (!usoActivoSnap.empty) throw new Error("El equipo ya est√° en uso.");

        const finDate = new Date();
        const [Hf,Mf] = r.hora_fin.split(":").map(Number);
        finDate.setHours(Hf, Mf||0, 0, 0);

        const usoRef = db.collection("usos").doc();
        tx.set(usoRef, {
          id_equipo: eq.codigo,
          nombre_equipo: `${eq.nombre} ${eq.marca} ${eq.modelo}`,
          cedula_estudiante: r.cedula_estudiante,
          nombre_estudiante: r.nombre_estudiante,
          id_reserva: r.id,
          inicio: firebase.firestore.Timestamp.fromDate(new Date()),
          fin: firebase.firestore.Timestamp.fromDate(finDate),
          activo: true
        });
        tx.update(eqRef, { estado: "en_uso" });

        const ahora = new Date();
        const docIdUsoLibre = `${r.cedula_estudiante}_${hoyStr()}_${pad(ahora.getHours())}:${pad(ahora.getMinutes())}_${eq.codigo}_usoReserva`;
        tx.set(db.collection("uso_libre").doc(docIdUsoLibre), {
          id: r.cedula_estudiante,
          nombre: r.nombre_estudiante,
          cedula: r.cedula_estudiante,
          equipo_codigo: eq.codigo,
          equipo_nombre: eq.nombre,
          equipo_marca: eq.marca,
          equipo_modelo: eq.modelo,
          fecha: hoyStr(),
          hora: `${pad(ahora.getHours())}:${pad(ahora.getMinutes())}`,
          tipo: "uso_reserva",
          reserva_hora_inicio: r.hora_inicio,
          reserva_hora_fin: r.hora_fin,
          timestamp: firebase.firestore.Timestamp.fromDate(ahora)
        }, { merge: true });
        tx.delete(db.collection("reservas").doc(r.id));
      });
      alert("‚úÖ Uso iniciado correctamente.");
    } catch(e){
      console.error(e); alert("‚ùå No se pudo iniciar el uso: " + e.message);
    } finally { cerrarModal(); }
  }

  /* ===================== ESC√ÅNER (clases/pr√°cticas) ===================== */
  function iniciarEscaner() {
    if (scanner) { scanner.clear().catch(()=>{}); scanner = null; }
    scanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: 250 });
    scanner.render(async (decodedText) => {
      scanner.clear();
      const cedula = extraerCedulaDesdeQR(decodedText);
      if (!cedula) { alert("‚ö†Ô∏è QR inv√°lido"); mostrarSeccion("menu"); return; }

      // Reglas nuevas SOLO para clases/pr√°cticas:
  if (tipoAsistenciaSeleccionado === "clase" || tipoAsistenciaSeleccionado === "practica") {
  if (!auth.currentUser) { alert("üîê Inicia sesi√≥n para registrar asistencia."); mostrarSeccion("menu"); return; }

  // Siempre: validaciones de alumno
  if (!miCedula) {
    // Verificamos que el QR escaneado coincide con su correo  en estudiantes:
    const estDoc = await db.collection("estudiantes").doc(cedula).get();
    if (!estDoc.exists) { alert("‚ùå Estudiante no encontrado"); mostrarSeccion("menu"); return; }
    const datosE = estDoc.data();
    if ((datosE.correo_institucional||"").trim().toLowerCase() !== (auth.currentUser.email||"").toLowerCase()) {
      alert("‚ùå Este QR no corresponde a tu correo registrado. Vincula tu cuenta desde 'Registrarme'.");
      mostrarSeccion("menu"); return;
    }
    // Vincular:
    miCedula = cedula; localStorage.setItem('miCedula', miCedula);
    const ok = await asegurarVinculoDispositivo(miCedula);
    if (!ok) { mostrarSeccion("menu"); return; }
  }

  if (cedula !== miCedula) { alert("‚ùå Solo puedes registrar tu propia asistencia."); mostrarSeccion("menu"); return; }
  const ok2 = await asegurarVinculoDispositivo(miCedula);
  if (!ok2) { mostrarSeccion("menu"); return; }
}

      const ahora = new Date();
      try {
        const estDoc = await db.collection("estudiantes").doc(cedula).get();
        if (!estDoc.exists) { alert("‚ùå Estudiante no encontrado"); mostrarSeccion("menu"); return; }
        const datos = estDoc.data();

        const fechaMostrar = `${ahora.getDate()}/${ahora.getMonth() + 1}/${ahora.getFullYear()}`;
        const fechaID = `${ahora.getFullYear()}-${(ahora.getMonth() + 1).toString().padStart(2, "0")}-${ahora.getDate().toString().padStart(2, "0")}`;
        const hora = `${ahora.getHours().toString().padStart(2, "0")}:00`;
        const dia = ["domingo", "lunes", "martes", "miercoles", "jueves", "viernes", "sabado"][ahora.getDay()];
        const timestamp = firebase.firestore.Timestamp.fromDate(ahora);

        // === Ruta antigua de USO LIBRE (se conserva) ===
        if (tipoAsistenciaSeleccionado === "libre") {
          const docId = `${cedula}_${fechaID}_${hora}_usoLibre`;
          const docRef = db.collection("asistencias").doc(docId);
          if ((await docRef.get()).exists) { alert("‚ö†Ô∏è Ya registraste uso libre recientemente"); mostrarSeccion("menu"); return; }
          await docRef.set({
            id: cedula, nombre: datos.nombre, cedula: datos.cedula, celular: datos.celular,
            fecha: fechaMostrar, hora, tipo: "uso libre", timestamp
          });
          alert(`‚úÖ Asistencia por uso libre registrada para ${datos.nombre}`);
          mostrarSeccion("menu"); return;
        }

        // === CLASES / PR√ÅCTICAS ===
        const horariosSnap = await db.collection("horario_laboratorio").where("dia", "==", dia).get();
        let clase = null;
        for (const doc of horariosSnap.docs) {
          const data = doc.data();
          const horaInicio = parseInt(data.hora.split(":")[0]);
          const horaFin = parseInt(data.hora_fin.split(":")[0]);
          const horaActual = ahora.getHours();
          if (horaInicio <= horaActual && horaActual < horaFin) { clase = data; break; }
        }
        if (!clase) { alert("‚ùå No hay clase programada en este horario"); mostrarSeccion("menu"); return; }
// === Validar que el estudiante est√© matriculado en la asignatura detectada ===
const validar = await validarAsignaturaEstudiante(cedula, clase.asignatura);
if (!validar.ok) {
  alert(validar.motivo);
  mostrarSeccion("menu");
  return;
}

        const asignaturaID = clase.asignatura.replace(/\s/g, "_");
        const docId = `${cedula}_${fechaID}_${clase.hora}_${asignaturaID}`;
        const docRef = db.collection("asistencias").doc(docId);
        if ((await docRef.get()).exists) { alert("‚ö†Ô∏è Ya registraste asistencia para esta clase"); mostrarSeccion("menu"); return; }

        const asistenciaData = {
          id: cedula, nombre: datos.nombre, cedula: datos.cedula, celular: datos.celular,
          fecha: fechaMostrar, hora: clase.hora, asignatura: clase.asignatura, profesor: clase.profesor,
          ciclo: clase.ciclo || "", tipo: tipoAsistenciaSeleccionado, timestamp
        };
        if (tipoAsistenciaSeleccionado === "practica") {
          asistenciaData.grupo = datosPractica.grupo;
          asistenciaData.preparatorio = datosPractica.preparatorio;
        }
        await docRef.set(asistenciaData);
        alert(`‚úÖ Asistencia registrada en ${clase.asignatura} para ${datos.nombre}`);
        mostrarSeccion("menu");
      } catch (e) {
        console.error(e); alert("‚ùå Error al registrar asistencia"); mostrarSeccion("menu");
      }
    });
  }

  /* ===================== Perfil + foto Base64 + mis asistencias ===================== */
  async function cargarPerfil(){
    const user = auth.currentUser;
    if (!user){ alert("Inicia sesi√≥n"); abrirLogin(); return; }

    // Si es alumno y no tiene miCedula vinculada, orientar:
    if (!miCedula) {
    alert("Escanea tu propio QR en 'Registrarme' para vincular tu cuenta a tu c√©dula.");
    return;
   }
   const ced = miCedula;


    const ref = db.collection("estudiantes").doc(ced);
    const snap = await ref.get();
    const d = snap.exists ? snap.data() : { nombre: "Alumno", correo_institucional: user.email };

    const cont = $("#perfilContent");
    cont.innerHTML = `
      <div class="rowg" style="align-items:flex-start">
        <img id="fotoPerfil" src="${ d.fotoBase64 ? d.fotoBase64 : 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0nMTAwJyBoZWlnaHQ9JzEwMCcgeG1sbnM9J2h0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnJz48Y2lyY2xlIGN4PSc1MCcgY3k9JzM2JyByPScyNCcgc3R5bGU9ImZpbGw6I2RlZGVlZSIvPjxyZWN0IHg9JzIwJyB5PSc2NCcgd2lkdGg9JzYwJyBoZWlnaHQ9JzI0JyBzdHlsZT0iZmlsbDojZGVkZWVlIi8+PC9zdmc+' }" style="width:72px;height:72px;border-radius:999px;object-fit:cover;border:1px solid #e5e7eb" />
        <div>
          <div><b>Nombre:</b> ${d.nombre || '-'}</div>
          <div><b>C√©dula:</b> ${ced}</div>
          <div><b>Correo institucional:</b> ${d.correo_institucional || user.email || '-'}</div>
          <div><b>Tel√©fono:</b> ${d.celular || '-'}</div>
          <div><b>Dispositivo vinculado:</b> ${d.deviceId ? 'S√≠' : 'No'}</div>
         <div class="muted">Solo puedes marcar tu propia asistencia desde tu dispositivo.</div>
        </div>
      </div>
    `;

    // Mis asistencias
    const lista = $("#misAsist"); lista.innerHTML = "Cargando‚Ä¶";
    try{
      const q = await db.collection("asistencias").where("cedula","==", ced).orderBy("fecha","desc").limit(100).get();
      if (q.empty) { lista.innerHTML = "<div class='muted'>Sin registros.</div>"; }
      else {
        lista.innerHTML = q.docs.map(d=>{
          const a = d.data();
          return `<div>‚Ä¢ ${a.fecha} ${a.hora} ‚Äî <b>${a.tipo||'-'}</b> ${a.asignatura? (' / '+a.asignatura):''}</div>`;
        }).join("");
      }
    }catch(e){ lista.innerHTML = "<div class='muted'>No se pudo cargar.</div>"; }

    // handler foto
    $("#fotoInput").onchange = async (ev)=>{
      const file = ev.target.files[0]; if (!file) return;
      resizeAndCompressImage(file, 300, 300, 0.7, async (base64)=>{
        try{ await db.collection("estudiantes").doc(ced).update({ fotoBase64: base64 }); $("#fotoPerfil").src = base64; alert("‚úÖ Foto actualizada"); }
        catch(e){ alert("‚ùå " + e.message); }
      });
    };
  }

  function resizeAndCompressImage(file, maxWidth, maxHeight, quality, cb) {
    const reader = new FileReader();
    reader.onload = function(event) {
      const img = new Image();
      img.onload = function() {
        let width = img.width, height = img.height;
        if (width > height && width > maxWidth) { height = Math.round(height * (maxWidth/width)); width = maxWidth; }
        else if (height > maxHeight) { width = Math.round(width * (maxHeight/height)); height = maxHeight; }
        const canvas = document.createElement("canvas");
        canvas.width = width; canvas.height = height;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(img, 0, 0, width, height);
        const base64 = canvas.toDataURL("image/jpeg", quality);
        cb(base64);
      };
      img.src = event.target.result;
    };
    reader.readAsDataURL(file);
  }

  /* ===================== Limpieza de usos vencidos ===================== */
  async function cleanupUsosVencidos(){
    const ahoraTS = firebase.firestore.Timestamp.fromDate(new Date());
    try {
      const qFin = await db.collection("usos").where("fin","<=",ahoraTS).get();
      if (!qFin.empty){ const batch1 = db.batch(); qFin.forEach(d => batch1.delete(d.ref)); await batch1.commit(); }
      const qInact = await db.collection("usos").where("activo","==",false).get();
      if (!qInact.empty){ const batch2 = db.batch(); qInact.forEach(d => batch2.delete(d.ref)); await batch2.commit(); }
    } catch(e){ console.warn('cleanupUsosVencidos:', e.message); }
  }

  /* ===================== Inicio ===================== */
  mostrarSeccion("menu");
  setInterval(cleanupUsosVencidos, 60*1000);

  function validarRedYUbicacionAntesDeEscanear(tipo) {
    fetch("https://ipinfo.io/json")
      .then(res => res.json())
      .then(() => {
        navigator.geolocation.getCurrentPosition((pos) => {
          const lat = pos.coords.latitude, lng = pos.coords.longitude;
          const LAT_PERMITIDA = -4.0300005, LNG_PERMITIDA = -79.1994490, RADIO_METROS = 20000;
          const distancia = calcularDistanciaMetros(lat, lng, LAT_PERMITIDA, LNG_PERMITIDA);
          if (distancia > RADIO_METROS) { alert("üö´ Fuera de la ubicaci√≥n permitida. No puedes registrar asistencia."); return; }
          tipoAsistenciaSeleccionado = tipo;
          mostrarSeccion("escaner");
        }, () => { alert("‚ùå No se pudo obtener tu ubicaci√≥n"); });
      })
      .catch(() => {
        navigator.geolocation.getCurrentPosition((pos) => {
          const lat = pos.coords.latitude, lng = pos.coords.longitude;
          const LAT_PERMITIDA = -4.0300005, LNG_PERMITIDA = -79.1994490, RADIO_METROS = 20000;
          const distancia = calcularDistanciaMetros(lat, lng, LAT_PERMITIDA, LNG_PERMITIDA);
          if (distancia > RADIO_METROS) { alert("üö´ Fuera de la ubicaci√≥n permitida. No puedes registrar asistencia."); return; }
          tipoAsistenciaSeleccionado = tipo;
          mostrarSeccion("escaner");
        }, () => { alert("‚ùå No se pudo obtener tu ubicaci√≥n"); });
      });
  }
</script>

</body>
</html>