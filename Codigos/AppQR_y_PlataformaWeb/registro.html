<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Registro de Estudiantes</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- LibrerÃ­as necesarias -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script> 

  <style>
    .menu-btn {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 6px;        /* menos padding */
  font-size: 12px;     /* letra mÃ¡s pequeÃ±a */
  border-radius: 10px;
  min-height: 80px;    /* altura mÃ¡s reducida */
  transition: transform 0.2s, box-shadow 0.2s;
}

.menu-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 3px 8px rgba(0,0,0,0.15);
}

.menu-icon {
  font-size: 30px;     /* Ã­cono mÃ¡s pequeÃ±o */
  width: 40px;
  height: 40px;
  display: flex;
  justify-content: center;
  align-items: center;
  border-radius: 8px;
  margin-bottom: 6px;  /* espacio reducido */
}

/* Estilo especÃ­fico para Excel */
.menu-btn:nth-child(2) .menu-icon {
  background-color: #217346; /* verde Excel */
  color: white;
  font-weight: bold;
  box-shadow: 0 2px 5px rgba(0,0,0,0.2);
}

    :root{
      --primario:#2563eb; --primario-osc:#1e40af;
      --bg:#f1f5f9; --texto:#0f172a; --borde:#e2e8f0;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,#fff,var(--bg));color:var(--texto); display: none;}
    .header{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--borde);z-index:5}
    .header-inner{max-width:1100px;margin:0 auto;padding:14px 20px;display:flex;align-items:center;justify-content:space-between;gap:12px}
    .brand{display:flex;align-items:center;gap:12px}
    .brand img{height:44px;object-fit:contain}
    .brand .title{font-weight:700;color:var(--primario-osc)}
    .brand .subtitle{font-size:.85rem;color:#475569}
    .container{max-width:1100px;margin:26px auto;padding:0 20px 40px}
    .card{background:#fff;border:1px solid var(--borde);border-radius:16px;padding:20px;box-shadow:0 8px 24px rgba(2,6,23,.06);margin:18px auto}
    .card h2,.card h3{margin:0 0 10px;color:var(--primario-osc)}
    .muted{color:#64748b;font-size:.92rem}
    .menu-grid{display:grid;gap:14px;grid-template-columns:repeat(3,minmax(180px,1fr))}
    .btn{display:inline-flex;align-items:center;justify-content:center;width:100%;padding:10px 14px;border-radius:12px;border:1px solid transparent;cursor:pointer;font-weight:600;transition:.2s;background:var(--primario);color:#fff}
    .btn:hover{background:var(--primario-osc)}
    .btn-outline{background:#fff;color:var(--primario-osc);border-color:var(--primario)}
    .btn-outline:hover{background:#eef2ff}
    .btn-ghost{background:transparent;color:var(--primario-osc)}
    form{width:100%}
    .form-grid{display:grid;gap:10px;grid-template-columns:1fr 1fr;max-width:720px}
    .form-grid .full{grid-column:1 / -1}
    .input, select{
      width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--borde);
      font-size:15px;outline:none;transition:border-color .15s, box-shadow .15s
    }
    .input:focus, select:focus{border-color:var(--primario);box-shadow:0 0 0 4px rgba(37,99,235,.12)}
    /* Secciones exclusivas */
    #seccion-manual, #seccion-excel { display:none; }
    #excelActions{display:grid;gap:10px;grid-template-columns:1fr 1fr;display:none}
    .footer{text-align:center;color:#94a3b8;font-size:.82rem;padding:20px 10px 40px}
    .pill{display:inline-block;padding:4px 10px;border:1px solid var(--borde);border-radius:999px;background:#f8fafc;margin-right:8px}
    .table{width:100%;border-collapse:collapse;margin-top:8px}
    .table th,.table td{border:1px solid var(--borde);padding:8px;text-align:left;font-size:14px}
    .section-sub{margin-top:12px;padding:10px;border:1px solid var(--borde);border-radius:10px;background:#fff}
    @media (max-width:720px){ .menu-grid{grid-template-columns:1fr} .form-grid{grid-template-columns:1fr} .brand img{height:38px} }
  </style>
</head>
<body>
<header class="header" style="background:#fff; border-bottom:1px solid #e2e8f0; padding:10px 20px;">
  <div class="header-inner" style="display:flex; align-items:center; justify-content:space-between; max-width:1100px; margin:0 auto;">
    <div class="brand" style="display:flex; align-items:center; gap:12px;">
      <img src="logounl.png" alt="Logo UNL" style="height:48px; width:auto;">
      <div style="line-height:1.2;">
        <div class="t1" style="font-size:1.1rem; font-weight:700; color:#1e40af;">Registro de Estudiantes</div>
        <div class="t2" style="font-size:0.85rem; color:#475569;">Laboratorio â€¢ Facultad de EnergÃ­a, Industrias y Recursos Naturales</div>
      </div>
    </div>
    <img src="logocit.png" alt="Logo laboratorio" style="height:48px; width:auto;">
  </div>
</header>
<div style="text-align:center; margin-bottom:15px; display: flex; justify-content: center; gap: 20px;">
    <button id="btnRegresar" style="padding: 8px 12px; background-color: #261cb7; color: white; border: none; border-radius: 4px; cursor: pointer;" onclick="window.location.href='portal.html'">
        ğŸ”™ Regresar al portal
    </button>
    
    <button id="btnLogout" style="padding: 8px 12px; background-color: #0f8a42; color: white; border: none; border-radius: 4px; cursor: pointer;" onclick="firebase.auth().signOut().then(() => { window.location.href = 'login.html'; })">
        ğŸšª Cerrar SesiÃ³n
    </button>
</div>
<main class="container">
  <!-- MenÃº principal -->
  <section id="seccion-menu" class="card" aria-labelledby="titulo-menu">
    <h2 id="titulo-menu">MenÃº principal</h2>
    <p class="muted">Elige cÃ³mo deseas registrar estudiantes.</p>
    <div class="menu-grid" role="group" aria-label="Acciones">
     
  <button class="btn" onclick="irA('manual')">
    <div class="menu-icon">ğŸ“</div>
    Registro manual
  </button>

  <button class="btn-outline menu-btn" onclick="irA('excel')">
    <div class="menu-icon">X</div>
    Cargar desde Excel
  </button>

  <button class="btn" onclick="irA('gestion')">
    <div class="menu-icon">ğŸ‘¤</div>
    Gestionar estudiantes
  </button>

</div>

    </div>
  </section>

  <!-- Registro MANUAL (con ciclo/asignatura/profesor) -->
  <section id="seccion-manual" class="card" aria-labelledby="titulo-manual">
    <h3 id="titulo-manual">Registro manual</h3>
    <p class="muted" style="margin-top:0">Campos clave marcados con *.</p>

    <form id="formRegistro" onsubmit="return false">
      <div class="form-grid">
        <input class="input full" type="text" id="nombre" placeholder='Nombre completo * (p.ej. "MERINO VERA CRISTIAN ANDRES")' required>
        <input class="input" type="text" id="cedula" placeholder="CÃ©dula * (p.ej. 0750943599)" required>
        <input class="input" type="text" id="celular" placeholder="Celular">
        <input class="input" type="email" id="correo_personal" placeholder="Correo personal">
        <input class="input" type="email" id="correo_institucional" placeholder="Correo institucional">
        <input class="input" type="text" id="canton_actual" placeholder="CantÃ³n actual">

       <!-- NUEVO: SelecciÃ³n Ciclo / Asignatura / Profesor -->
<div class="full nice-box" style="margin-top:12px;padding:16px;border-radius:14px;border:1px solid #ddd;background:#fafafa">

  <label style="font-weight:700;display:block;margin-bottom:10px;font-size:17px">
    Ciclos / Asignaturas
  </label>

  <!-- Ciclos -->
  <div id="ciclosChecklist" style="margin-bottom:18px">
    <label class="sub-title">Ciclos</label>
    <div class="tags-grid">
      <label class="tag-check"><input type="checkbox" value="1"> 1</label>
      <label class="tag-check"><input type="checkbox" value="2"> 2</label>
      <label class="tag-check"><input type="checkbox" value="3"> 3</label>
      <label class="tag-check"><input type="checkbox" value="4"> 4</label>
      <label class="tag-check"><input type="checkbox" value="5"> 5</label>
      <label class="tag-check"><input type="checkbox" value="6"> 6</label>
      <label class="tag-check"><input type="checkbox" value="7"> 7</label>
      <label class="tag-check"><input type="checkbox" value="8"> 8</label>
      <label class="tag-check"><input type="checkbox" value="9"> 9</label>
    </div>
  </div>

  <!-- Asignaturas -->
  <div id="asignaturasChecklist" class="nice-box" style="padding:12px;margin-top:12px;border:1px dashed #ccc;border-radius:10px;background:#fff"></div>

 

  <div id="asigHintManual" style="display:none;color:#d9534f;margin-top:6px;font-size:14px">
    No se encontraron asignaturas.
  </div>
</div>


      <div style="display:grid;gap:10px;grid-template-columns:1fr 1fr;margin-top:12px;max-width:520px">
        <button type="submit" class="btn">Guardar estudiante</button>
        <button type="button" class="btn-ghost" onclick="irA('menu')">Volver</button>
      </div>
    </form>
  </section>

  <!-- CARGA DESDE EXCEL (como lo tenÃ­as) -->
  <section id="seccion-excel" class="card" aria-labelledby="titulo-excel">
    <h3 id="titulo-excel">Carga masiva desde Excel</h3>
    <p class="muted" style="margin-top:0">
      Se mantiene el flujo existente: hoja 1, datos desde fila 12 (columnas Câ†’Q).
    </p>

    <input class="input" type="file" id="excelUploader" accept=".xlsx" aria-label="Subir archivo Excel">

    <!-- Meta (profesor, ciclo) y selector de asignatura -->
    <div id="excelMeta" class="section-sub" style="display:none">
      <div style="margin-bottom:8px">
        <span class="pill">Profesor: <strong id="metaProfesor"></strong></span>
        <span class="pill">Ciclo: <strong id="metaCiclo"></strong></span>
      </div>
      <label for="selectAsignatura" style="font-weight:600">Asignatura</label>
      <select id="selectAsignatura" class="input" style="margin-top:6px">
        <option value="">â€” Selecciona una asignatura â€”</option>
      </select>
      <div id="asigHint" class="muted" style="margin-top:6px;display:none">No se encontraron asignaturas para este profesor/ciclo.</div>
    </div>

    <!-- Listado de estudiantes leÃ­dos -->
    <div id="excelList" class="section-sub" style="display:none">
      <div style="font-weight:600;margin-bottom:6px">Estudiantes leÃ­dos</div>
      <div style="max-height:260px;overflow:auto;border:1px solid var(--borde);border-radius:10px">
        <table class="table">
          <thead>
            <tr><th>Nombre</th><th>CÃ©dula</th></tr>
          </thead>
          <tbody id="excelListBody"></tbody>
        </table>
      </div>
    </div>

    <div id="excelActions" style="margin-top:10px;display:grid;gap:10px;grid-template-columns:1fr 1fr;">
      <button class="btn" onclick="confirmarCarga()">Subir estudiantes</button>
      <button class="btn-ghost" onclick="cancelarCarga()">Cancelar</button>
    </div>
    <div style="margin-top:12px;max-width:520px">
      <button class="btn-outline" onclick="irA('menu')">Volver</button>
    </div>
  </section>
  <!-- GESTIÃ“N DE ESTUDIANTES -->
<section id="seccion-gestion" class="card" aria-labelledby="titulo-gestion" style="display:none">
  <h3 id="titulo-gestion">Buscar / Editar / Eliminar estudiantes</h3>
  <p class="muted" style="margin-top:0">Busca por cÃ©dula o apedillo.</p>

  <div style="display:flex; gap:10px; max-width:500px; margin-bottom:12px;">
    <input class="input" type="text" id="busqueda" placeholder="Buscar estudiante...">
    <button class="btn" onclick="buscarEstudiante()">Buscar</button>
  </div>

  <div id="resultadoBusqueda" style="display:none; margin-top:16px;">
    <table class="table">
      <thead>
        <tr><th>Nombre</th><th>CÃ©dula</th><th>Acciones</th></tr>
      </thead>
      <tbody id="tablaResultados"></tbody>
    </table>
  </div>

  <div style="margin-top:14px;">
    <button class="btn-ghost" onclick="irA('menu')">Volver</button>
  </div>
</section>
<!-- Modal para ver/editar estudiante -->
<div id="modalEstudiante" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);justify-content:center;align-items:center;z-index:1000;">
  <div style="background:#fff;border-radius:16px;padding:20px;max-width:500px;width:90%;position:relative;">
    <button onclick="cerrarModal()" style="position:absolute;top:10px;right:10px;font-size:18px;background:none;border:none;cursor:pointer;">âœ–ï¸</button>
    <h3 id="modalNombre"></h3>
   <!-- <img id="modalFoto" src="" alt="Foto estudiante" style="width:120px;height:120px;object-fit:cover;border-radius:50%;margin-bottom:12px;">-->
    <div style="display:grid;gap:8px;margin-bottom:12px;">
      <input class="input" id="modalCedula" placeholder="CÃ©dula">
      <input class="input" id="modalCelular" placeholder="Celular">
      <input class="input" id="modalCorreoPersonal" placeholder="Correo personal">
      <input class="input" id="modalCorreoInstitucional" placeholder="Correo institucional">
      <input class="input" id="modalCanton" placeholder="CantÃ³n">
      <input class="input" id="modalGenero" placeholder="GÃ©nero">
      <input class="input" id="modalEstadoCivil" placeholder="Estado civil">
      <input class="input" id="modalFechaNacimiento" placeholder="Fecha de nacimiento">
      <input class="input" id="modalNacionalidad" placeholder="Nacionalidad">
      <input class="input" id="modalProvincia" placeholder="Provincia actual">
      <input class="input" id="modalParroquia" placeholder="Parroquia actual">
      <input class="input" id="modalDireccion" placeholder="DirecciÃ³n actual">
    </div>
    <div style="display:flex;gap:10px;justify-content:flex-end;">
      <button class="btn" onclick="guardarEdicion()">ğŸ’¾ Guardar</button>
      <button class="btn-ghost" onclick="eliminarEstudianteActual()">ğŸ—‘ï¸ Eliminar</button>
    </div>
  </div>
</div>

</main>

<footer class="footer">
  Â© <span id="year"></span> â€” Registro de Estudiantes â€¢ Uso acadÃ©mico
</footer>

<script>
Â  // ----- Firebase (igual) -----
Â  const firebaseConfig = {
Â  Â  apiKey: "AIzaSyBByttCwTn1hMwo9X5P2gbsYlSq9lGa7t0",
Â  Â  authDomain: "escaner-qr-d7d65.firebaseapp.com",
Â  Â  projectId: "escaner-qr-d7d65",
Â  Â  storageBucket: "escaner-qr-d7d65.appspot.com",
Â  Â  messagingSenderId: "982923527298",
Â  Â  appId: "1:982923527298:web:df13850f38d847cfdae09b"
Â  };
Â  firebase.initializeApp(firebaseConfig);
Â  const db = firebase.firestore();
  // Nota: Asume que firebase.auth() se inicializa mÃ¡s abajo
  // o en el <head> si usaste la compat library.

Â  // ----- Estado -----
Â  let estudiantesPendientes = [];
Â  //let id_registro = 1;
Â  document.getElementById("year").textContent = new Date().getFullYear();

Â  // Meta leÃ­da del Excel
Â  let metaExcel = { ciclo: null, profesor: "" };

Â  // ----- Helpers comunes (se mantienen) -----
Â  function leerTextoCelda(hoja, ref){
Â  Â  const c = hoja?.[ref];
Â  Â  return (c?.w ?? c?.v ?? "").toString().trim();
Â  }
Â  function extraerCicloDesde(texto){
Â  Â  const m = texto.match(/\d+/);
Â  Â  return m ? parseInt(m[0], 10) : null;
Â  }
Â  function normalizarNombreConIng(textoDocente){
Â  Â  // quita "Docente:" y pasa a "Ing. Nombre Apellido"
Â  Â  let base = textoDocente.replace(/^\s*docente\s*[:\-]?\s*/i, "").trim().toLowerCase();
Â  Â  base = base.split(/\s+/).map(p => p.charAt(0).toUpperCase() + p.slice(1)).join(" ");
Â  Â  return `Ing. ${base}`.trim();
Â  }
Â  function renderListaEstudiantes(rows){
Â  Â  const tbody = document.getElementById("excelListBody");
Â  Â  tbody.innerHTML = "";
Â  Â  rows.forEach(r => {
Â  Â  Â  const ced = (r["C"] ?? "").toString().trim();
Â  Â  Â  const nom = (r["D"] ?? "").toString().trim();
Â  Â  Â  if(!ced && !nom) return;
Â  Â  Â  const tr = document.createElement("tr");
Â  Â  Â  const tdN = document.createElement("td"); tdN.textContent = nom;
Â  Â  Â  const tdC = document.createElement("td"); tdC.textContent = ced.length===9?("0"+ced):ced;
Â  Â  Â  tr.appendChild(tdN); tr.appendChild(tdC);
Â  Â  Â  tbody.appendChild(tr);
Â  Â  });
Â  Â  document.getElementById("excelList").style.display = "block";
Â  }

Â  async function cargarAsignaturasParaMeta(){
Â  Â  const metaBox = document.getElementById("excelMeta");
Â  Â  const sel = document.getElementById("selectAsignatura");
Â  Â  const hint = document.getElementById("asigHint");
Â  Â  sel.innerHTML = '<option value="">â€” Selecciona una asignatura â€”</option>';
Â  Â  hint.style.display = "none";

Â  Â  if(!Number.isFinite(metaExcel.ciclo) || !metaExcel.profesor){
Â  Â  Â  metaBox.style.display = "none";
Â  Â  Â  return;
Â  Â  }
Â  Â  document.getElementById("metaProfesor").textContent = metaExcel.profesor;
Â  Â  document.getElementById("metaCiclo").textContent = metaExcel.ciclo;
Â  Â  metaBox.style.display = "block";

Â  Â  const qSnap = await db.collection("clases_definidas")
Â  Â  Â  .where("ciclo","==", String(metaExcel.ciclo))
Â  Â  Â  .where("profesor","==", metaExcel.profesor)
Â  Â  Â  .get();

Â  Â  if(qSnap.empty){
Â  Â  Â  hint.style.display = "block";
Â  Â  Â  return;
Â  Â  }
Â  Â  qSnap.forEach(doc => {
Â  Â  Â  const data = doc.data();
Â  Â  Â  const opt = document.createElement("option");
Â  Â  Â  opt.value = data.asignatura;
Â  Â  Â  opt.textContent = data.asignatura;
Â  Â  Â  sel.appendChild(opt);
Â  Â  });
Â  }

Â  // ----- NavegaciÃ³n (Se mantiene la funciÃ³n, la llamada se mueve) -----
Â  function irA(seccion){
Â  Â  document.getElementById("seccion-menu").style.display = "none";
Â  Â  document.getElementById("seccion-manual").style.display = "none";
Â  Â  document.getElementById("seccion-excel").style.display = "none";
Â  Â  document.getElementById("seccion-gestion").style.display = "none";
Â  Â  if(seccion === 'menu') Â document.getElementById("seccion-menu").style.display = "block";
Â  Â  if(seccion === 'manual')document.getElementById("seccion-manual").style.display = "block";
Â  Â  if(seccion === 'excel') document.getElementById("seccion-excel").style.display = "block";
Â  Â  if(seccion === 'gestion') document.getElementById("seccion-gestion").style.display = "block";
Â  }
Â  // irA('menu'); // ğŸ›‘ ESTA LLAMADA SE MUEVE a inicializarGestion()

Â  // ====== EXCEL (lo existente) ======
Â  // ğŸ›‘ Los event listeners se MOVERÃN a inicializarGestion()

Â  document.getElementById("excelUploader")?.addEventListener("change", async function(event) {
Â  Â  const file = event.target.files[0];
Â  Â  if (!file) return;

Â  Â  const data = await file.arrayBuffer();
Â  Â  const workbook = XLSX.read(data);
Â  Â  const hoja = workbook.Sheets[workbook.SheetNames[0]];

Â  Â  const textoCiclo Â  = leerTextoCelda(hoja, "D4");
Â  Â  const textoDocente = leerTextoCelda(hoja, "D9");
Â  Â  metaExcel.ciclo Â  Â = extraerCicloDesde(textoCiclo);
Â  Â  metaExcel.profesor = normalizarNombreConIng(textoDocente);

Â  Â  console.log("Ciclo leÃ­do:", metaExcel.ciclo, "Profesor leÃ­do:", metaExcel.profesor);

Â  Â  estudiantesPendientes = XLSX.utils.sheet_to_json(hoja, { range: 11, header: "A" });
Â  Â  renderListaEstudiantes(estudiantesPendientes);

Â  Â  document.getElementById("excelActions").style.display = "grid";
Â  Â  await cargarAsignaturasParaMeta();
Â  });

Â  function cancelarCarga() {
Â  Â  estudiantesPendientes = [];
Â  Â  document.getElementById("excelUploader").value = null;
Â  Â  document.getElementById("excelActions").style.display = "none";
Â  Â  document.getElementById("excelMeta").style.display = "none";
Â  Â  document.getElementById("excelList").style.display = "none";
Â  Â  document.getElementById("excelListBody").innerHTML = "";
Â  Â  document.getElementById("selectAsignatura").innerHTML = '<option value="">â€” Selecciona una asignatura â€”</option>';
Â  Â  alert("âŒ Carga cancelada");
Â  }

Â  async function confirmarCarga() {
Â  Â  const asignaturaSel = document.getElementById("selectAsignatura").value;
Â  Â  if(!asignaturaSel){
Â  Â  Â  alert("Selecciona una asignatura antes de subir.");
Â  Â  Â  return;
Â  Â  }

Â  Â  let nuevos = 0;
Â  Â  let actualizados = 0;

Â  Â  for (const row of estudiantesPendientes) {
Â  Â  Â  let cedula = row["C"]?.toString().trim();
Â  Â  Â  if (cedula && cedula.length === 9) cedula = "0" + cedula;
Â  Â  Â  if (!cedula) continue;

Â  Â  Â  const docRef = db.collection("estudiantes").doc(cedula);
Â  Â  Â  const docSnap = await docRef.get();

Â  Â  Â  const datosExcel = {
Â  Â  Â  Â  cedula,
Â  Â  Â  Â  nombre: row["D"]?.toString().trim() || "",
Â  Â  Â  Â  genero: row["E"]?.toString().trim() || "",
Â  Â  Â  Â  correo_institucional: row["F"]?.toString().trim() || "",
Â  Â  Â  Â  correo_personal: row["G"]?.toString().trim() || "",
Â  Â  Â  Â  celular: row["H"]?.toString().trim() || "",
Â  Â  Â  Â  telefono: row["I"]?.toString().trim() || "",
Â  Â  Â  Â  estado_civil: row["J"]?.toString().trim() || "",
Â  Â  Â  Â  etnia: row["K"]?.toString().trim() || "",
Â  Â  Â  Â  fecha_nacimiento: row["L"]?.toString().trim() || "",
Â  Â  Â  Â  nacionalidad: row["M"]?.toString().trim() || "",
Â  Â  Â  Â  provincia_actual: row["N"]?.toString().trim() || "",
Â  Â  Â  Â  canton_actual: row["O"]?.toString().trim() || "",
Â  Â  Â  Â  parroquia_actual: row["P"]?.toString().trim() || "",
Â  Â  Â  Â  direccion_actual: row["Q"]?.toString().trim() || ""
Â  Â  Â  };

Â  Â  Â  const nuevaAsignacion = {
Â  Â  Â  Â  ciclo: Number.isFinite(metaExcel.ciclo) ? metaExcel.ciclo : null,
Â  Â  Â  Â  profesor: metaExcel.profesor || "",
Â  Â  Â  Â  asignatura: asignaturaSel || ""
Â  Â  Â  };

Â  Â  Â  if (docSnap.exists) {
Â  Â  Â  Â  const dataActual = docSnap.data();
Â  Â  Â  Â  let asignaciones = Array.isArray(dataActual.asignaciones) ? dataActual.asignaciones : [];
Â  Â  Â  Â  let ciclosIdx Â  Â = Array.isArray(dataActual.ciclos) ? dataActual.ciclos : [];
Â  Â  Â  Â  let profesoresIdx = Array.isArray(dataActual.profesores) ? dataActual.profesores : [];

Â  Â  Â  Â  const existeAsignacion = asignaciones.some(a =>
Â  Â  Â  Â  Â  a.ciclo === nuevaAsignacion.ciclo &&
Â  Â  Â  Â  Â  a.profesor === nuevaAsignacion.profesor &&
Â  Â  Â  Â  Â  a.asignatura === nuevaAsignacion.asignatura
Â  Â  Â  Â  );
Â  Â  Â  Â  if (!existeAsignacion) asignaciones.push(nuevaAsignacion);

Â  Â  Â  Â  if (Number.isFinite(nuevaAsignacion.ciclo) && !ciclosIdx.includes(nuevaAsignacion.ciclo)) ciclosIdx.push(nuevaAsignacion.ciclo);
Â  Â  Â  Â  if (nuevaAsignacion.profesor && !profesoresIdx.includes(nuevaAsignacion.profesor)) profesoresIdx.push(nuevaAsignacion.profesor);

Â  Â  Â  Â  await docRef.update({
Â  Â  Â  Â  Â  ...datosExcel,
Â  Â  Â  Â  Â  asignaciones,
Â  Â  Â  Â  Â  ciclos: ciclosIdx,
Â  Â  Â  Â  Â  profesores: profesoresIdx
Â  Â  Â  Â  });

Â  Â  Â  Â  actualizados++;

Â  Â  Â  } else {
Â  Â  Â  Â  

Â  Â  Â  Â  const estudianteNuevo = {
Â  Â  Â  Â  Â  ...datosExcel,
Â  Â  Â  Â  Â  //id_registro: idAsignado,
Â  Â  Â  Â  Â  asignaciones: [nuevaAsignacion],
Â  Â  Â  Â  Â  ciclos: Number.isFinite(nuevaAsignacion.ciclo) ? [nuevaAsignacion.ciclo] : [],
Â  Â  Â  Â  Â  profesores: nuevaAsignacion.profesor ? [nuevaAsignacion.profesor] : []
Â  Â  Â  Â  };

Â  Â  Â  Â  await docRef.set(estudianteNuevo);
Â  Â  Â  Â 

Â  Â  Â  Â  nuevos++;
Â  Â  Â  }
Â  Â  }

Â  Â  estudiantesPendientes = [];
Â  Â  document.getElementById("excelUploader").value = null;
Â  Â  document.getElementById("excelActions").style.display = "none";
Â  Â  document.getElementById("excelMeta").style.display = "none";
Â  Â  document.getElementById("excelList").style.display = "none";
Â  Â  document.getElementById("excelListBody").innerHTML = "";
Â  Â  document.getElementById("selectAsignatura").innerHTML = '<option value="">â€” Selecciona una asignatura â€”</option>';

Â  Â  alert(`âœ… Procesados: ${nuevos + actualizados}\nğŸ†• Nuevos: ${nuevos}\nğŸ” Actualizados: ${actualizados}`);
Â  }

Â // ====== MANUAL: lÃ³gica de ciclo/asignatura/profesor con checklists y profesor visible ======
const ciclosChecklistEl = document.getElementById('ciclosChecklist');
const asignaturasChecklistEl = document.getElementById('asignaturasChecklist');
const asigHintManualEl = document.getElementById('asigHintManual');

let items = []; // asignaturas cargadas segÃºn ciclos seleccionados

// ğŸ›‘ Los event listeners se MOVERÃN a inicializarGestion()
ciclosChecklistEl?.addEventListener('change', async () => {

Â  asignaturasChecklistEl.innerHTML = '';
Â  asigHintManualEl.style.display = 'none';

Â  // ciclos seleccionados
Â  const ciclosSel = Array.from(
Â  Â  ciclosChecklistEl.querySelectorAll('input:checked')
Â  ).map(c => c.value);

Â  if (ciclosSel.length === 0) return;

Â  items = [];

Â  // cargar asignaturas desde Firestore
Â  for (const ciclo of ciclosSel) {

Â  Â  const qSnap = await db.collection('clases_definidas')
Â  Â  Â  .where('ciclo', '==', ciclo)
Â  Â  Â  .get();

Â  Â  qSnap.forEach(doc => {
Â  Â  Â  const data = doc.data();
Â  Â  Â  items.push({
Â  Â  Â  Â  ciclo,
Â  Â  Â  Â  asignatura: data.asignatura,
Â  Â  Â  Â  profesor: data.profesor
Â  Â  Â  });
Â  Â  });
Â  }

Â  // si no hay asignaturas
Â  if (items.length === 0) {
Â  Â  asigHintManualEl.style.display = 'block';
Â  Â  return;
Â  }

Â  asignaturasChecklistEl.innerHTML = '';

Â  // Mostrar agrupadas por ciclo
Â  ciclosSel.forEach(ciclo => {
Â  Â  const grupo = items.filter(i => i.ciclo === ciclo);
Â  Â  if (grupo.length === 0) return;

Â  Â  const box = document.createElement('div');
Â  Â  box.style.marginBottom = '12px';

Â  Â  const title = document.createElement('div');
Â  Â  title.textContent = `Ciclo ${ciclo}`;
Â  Â  title.style.fontWeight = '600';
Â  Â  title.style.marginBottom = '6px';
Â  Â  box.appendChild(title);

Â  Â  grupo.forEach(i => {
Â  Â  Â  const lbl = document.createElement('label');
Â  Â  Â  lbl.style.display = 'block';
Â  Â  Â  lbl.style.marginLeft = '14px';
Â  Â  Â  lbl.style.marginBottom = '3px';

Â  Â  Â  lbl.innerHTML = `
Â  Â  Â  Â  <input type="checkbox" value="${i.ciclo}||${i.asignatura}">
Â  Â  Â  Â  ${i.asignatura} 
Â  Â  Â  Â  <span style="color:#777;font-size:0.9em">(${i.profesor})</span>
Â  Â  Â  `;

Â  Â  Â  // CUANDO SELECCIONE UNA ASIGNATURA â†’ pones profesor automÃ¡ticamente
Â  Â  Â  lbl.querySelector("input")?.addEventListener("change", (e) => {
Â  Â  Â  Â  if (e.target.checked) {
Â  Â  Â  Â  Â  // Se asume que 'profesorManualEl' es el input de profesor en el formulario manual,
Â  Â  Â  Â  Â  // aunque no estÃ¡ declarado en el cÃ³digo provisto. Usaremos un selector si existe.
Â  Â  Â  Â  Â  document.getElementById("profesorManual") && (document.getElementById("profesorManual").value = i.profesor);
Â  Â  Â  Â  }
Â  Â  Â  });

Â  Â  Â  box.appendChild(lbl);
Â  Â  });

Â  Â  asignaturasChecklistEl.appendChild(box);
Â  });
});


// ----- Registro manual -----
// ğŸ›‘ Los event listeners se MOVERÃN a inicializarGestion()
document.getElementById("formRegistro")?.addEventListener("submit", async function (e) {
Â  e.preventDefault();

Â  const nombre = document.getElementById("nombre").value.trim();
Â  let cedula = document.getElementById("cedula").value.trim();
Â  if (cedula.length === 9) cedula = "0" + cedula;

Â  const asignaturasSeleccionadas = Array.from(
Â  Â  asignaturasChecklistEl.querySelectorAll('input:checked')
Â  ).map(i => {
Â  Â  const [ciclo, asignatura] = i.value.split("||");
Â  Â  const prof = items.find(x => x.ciclo === ciclo && x.asignatura === asignatura);
Â  Â  return {
Â  Â  Â  ciclo: Number(ciclo),
Â  Â  Â  asignatura,
Â  Â  Â  profesor: prof ? prof.profesor : ""
Â  Â  };
Â  });

Â  if (asignaturasSeleccionadas.length === 0) {
Â  Â  alert("Selecciona al menos una asignatura.");
Â  Â  return;
Â  }

Â  const payload = {
Â  Â  nombre,
Â  Â  cedula,
Â  Â  celular: document.getElementById("celular").value.trim() || "",
Â  Â  correo_personal: document.getElementById("correo_personal").value.trim() || "",
Â  Â  correo_institucional: document.getElementById("correo_institucional").value.trim() || "",
Â  Â  canton_actual: document.getElementById("canton_actual").value.trim() || ""
Â  };

Â  const docRef = db.collection("estudiantes").doc(cedula);
Â  const docSnap = await docRef.get();

Â  if (docSnap.exists) {
Â  Â  const dataActual = docSnap.data();
Â  Â  let asignaciones = Array.isArray(dataActual.asignaciones) ? dataActual.asignaciones : [];

Â  Â  asignaturasSeleccionadas.forEach(a => {
Â  Â  Â  const ya = asignaciones.some(x =>
Â  Â  Â  Â  x.ciclo === a.ciclo &&
Â  Â  Â  Â  x.asignatura === a.asignatura &&
Â  Â  Â  Â  x.profesor === a.profesor
Â  Â  Â  );
Â  Â  Â  if (!ya) asignaciones.push(a);
Â  Â  });

Â  Â  await docRef.update({
Â  Â  Â  ...payload,
Â  Â  Â  asignaciones,
Â  Â  Â  ciclos: [...new Set(asignaciones.map(a => a.ciclo))],
Â  Â  Â  profesores: [...new Set(asignaciones.map(a => a.profesor))]
Â  Â  });

Â  Â  alert("âœ… Estudiante actualizado");

Â  } else {

Â  Â  await docRef.set({
Â  Â  Â  ...payload,
Â  Â  Â  asignaciones: asignaturasSeleccionadas,
Â  Â  Â  ciclos: [...new Set(asignaturasSeleccionadas.map(a => a.ciclo))],
Â  Â  Â  profesores: [...new Set(asignaturasSeleccionadas.map(a => a.profesor))]
Â  Â  });

Â  Â  alert("âœ… Estudiante registrado");
Â  }

Â  document.getElementById("formRegistro").reset();
Â  asignaturasChecklistEl.innerHTML = '';
Â  asigHintManualEl.style.display = 'none';
});

// ====== GESTIÃ“N DE ESTUDIANTES (se mantiene la lÃ³gica) ======
async function buscarEstudiante(){
Â  const term = document.getElementById("busqueda").value.trim().toLowerCase();
Â  if(!term){ alert("Ingrese una cÃ©dula o nombre para buscar."); return; }

Â  let resultados = [];

Â  // Buscar por cÃ©dula exacta
Â  const docCed = await db.collection("estudiantes").doc(term).get();
Â  if(docCed.exists){
Â  Â  resultados.push({ id: docCed.id, ...docCed.data() });
Â  } else {
Â  Â  // Buscar por nombre (inicia con)
Â  Â  const snap = await db.collection("estudiantes")
Â  Â  Â  .orderBy("nombre")
Â  Â  Â  .startAt(term.toUpperCase())
Â  Â  Â  .endAt(term.toUpperCase() + "\uf8ff")
Â  Â  Â  .get();

Â  Â  snap.forEach(d => resultados.push({ id: d.id, ...d.data() }));
Â  }

Â  const tabla = document.getElementById("tablaResultados");
Â  tabla.innerHTML = "";
Â  if(resultados.length === 0){
Â  Â  tabla.innerHTML = `<tr><td colspan="3">No se encontraron resultados.</td></tr>`;
Â  } else {
Â  Â  resultados.forEach(r => {
Â  Â  Â  const tr = document.createElement("tr");
Â  Â  Â  tr.innerHTML = `
Â  Â  Â  Â  <td>${r.nombre}</td>
Â  Â  Â  Â  <td>${r.cedula}</td>
Â  Â  Â  Â  <td>
Â  Â  Â  Â  Â  <button class="btn" onclick="editarEstudiante('${r.id}')">Ver / Editar</button>
Â  Â  Â  Â  Â  <button class="btn btn-red" onclick="eliminarEstudiante('${r.id}')">Eliminar</button>
Â  Â  Â  Â  </td>
Â  Â  Â  `;
Â  Â  Â  tabla.appendChild(tr);
Â  Â  });
Â  }

Â  document.getElementById("resultadoBusqueda").style.display = "block";
}

async function eliminarEstudiante(id){
Â  if(!confirm("Â¿Seguro que deseas eliminar este estudiante?")) return;

Â  await db.collection("estudiantes").doc(id).delete();

Â  // TambiÃ©n eliminar del Ã­ndice de huellas si existe (comentado en el cÃ³digo original)
Â  //const indiceSnap = await db.collection("indice_huellas").where("cedula","==",id).get();
Â  //indiceSnap.forEach(async d => await db.collection("indice_huellas").doc(d.id).delete());

Â  alert("ğŸ—‘ï¸ Estudiante eliminado correctamente.");
Â  buscarEstudiante(); // refresca la lista
}

let estudianteActualId = null; // guarda ID del estudiante abierto en el modal

// Abre el modal con todos los datos
async function editarEstudiante(id){
Â  const docSnap = await db.collection("estudiantes").doc(id).get();
Â  if(!docSnap.exists){ alert("Estudiante no encontrado."); return; }
Â  const data = docSnap.data();
Â  estudianteActualId = id;

Â  document.getElementById("modalNombre").textContent = data.nombre || "";
Â  //document.getElementById("modalFoto").src = data.foto || "placeholder.png"; // foto o placeholder
Â  document.getElementById("modalCedula").value = data.cedula || "";
Â  document.getElementById("modalCelular").value = data.celular || "";
Â  document.getElementById("modalCorreoPersonal").value = data.correo_personal || "";
Â  document.getElementById("modalCorreoInstitucional").value = data.correo_institucional || "";
Â  document.getElementById("modalCanton").value = data.canton_actual || "";
Â  document.getElementById("modalGenero").value = data.genero || "";
Â  document.getElementById("modalEstadoCivil").value = data.estado_civil || "";
Â  document.getElementById("modalFechaNacimiento").value = data.fecha_nacimiento || "";
Â  document.getElementById("modalNacionalidad").value = data.nacionalidad || "";
Â  document.getElementById("modalProvincia").value = data.provincia_actual || "";
Â  document.getElementById("modalParroquia").value = data.parroquia_actual || "";
Â  document.getElementById("modalDireccion").value = data.direccion_actual || "";

Â  document.getElementById("modalEstudiante").style.display = "flex";
}

// Guardar ediciÃ³n
async function guardarEdicion(){
Â  if(!estudianteActualId) return;
Â  await db.collection("estudiantes").doc(estudianteActualId).update({
Â  Â  nombre: document.getElementById("modalNombre").textContent,
Â  Â  cedula: document.getElementById("modalCedula").value.trim(),
Â  Â  celular: document.getElementById("modalCelular").value.trim(),
Â  Â  correo_personal: document.getElementById("modalCorreoPersonal").value.trim(),
Â  Â  correo_institucional: document.getElementById("modalCorreoInstitucional").value.trim(),
Â  Â  canton_actual: document.getElementById("modalCanton").value.trim(),
Â  Â  genero: document.getElementById("modalGenero").value.trim(),
Â  Â  estado_civil: document.getElementById("modalEstadoCivil").value.trim(),
Â  Â  fecha_nacimiento: document.getElementById("modalFechaNacimiento").value.trim(),
Â  Â  nacionalidad: document.getElementById("modalNacionalidad").value.trim(),
Â  Â  provincia_actual: document.getElementById("modalProvincia").value.trim(),
Â  Â  parroquia_actual: document.getElementById("modalParroquia").value.trim(),
Â  Â  direccion_actual: document.getElementById("modalDireccion").value.trim(),
Â  });
Â  alert("âœ… Datos actualizados.");
Â  cerrarModal();
Â  buscarEstudiante();
}

// Cerrar modal
function cerrarModal(){
Â  estudianteActualId = null;
Â  document.getElementById("modalEstudiante").style.display = "none";
}

// Eliminar desde modal
async function eliminarEstudianteActual(){
Â  if(!estudianteActualId) return;
Â  if(!confirm("Â¿Seguro que deseas eliminar este estudiante?")) return;
Â  await db.collection("estudiantes").doc(estudianteActualId).delete();
Â  alert("ğŸ—‘ï¸ Estudiante eliminado.");
Â  cerrarModal();
Â  buscarEstudiante();
}

// ************************************************************
// 1. FUNCIÃ“N WRAPPER DE INICIALIZACIÃ“N
// ************************************************************
/**
 * Contiene la lÃ³gica de inicializaciÃ³n y asignaciÃ³n de eventos.
 */
function inicializarGestion(){
    // Iniciar en la pantalla del menÃº
    irA('menu'); 
    
    // Asignar eventos de navegaciÃ³n (asumiendo que los botones existen)
    document.getElementById("btnIrManual")?.addEventListener('click', () => irA('manual'));
    document.getElementById("btnIrExcel")?.addEventListener('click', () => irA('excel'));
    document.getElementById("btnIrGestion")?.addEventListener('click', () => irA('gestion'));

    // Asignar eventos de botones de Excel
    document.getElementById("btnCancelarCarga")?.addEventListener('click', cancelarCarga);
    document.getElementById("btnConfirmarCarga")?.addEventListener('click', confirmarCarga);

    // Asignar evento de bÃºsqueda
    document.getElementById("formBusqueda")?.addEventListener('submit', (e) => {
        e.preventDefault();
        buscarEstudiante();
    });

    // Asignar eventos de modal (asumiendo IDs en el HTML)
    document.getElementById("modalGuardar")?.addEventListener('click', guardarEdicion);
    document.getElementById("modalCerrar")?.addEventListener('click', cerrarModal);
    document.getElementById("modalEliminar")?.addEventListener('click', eliminarEstudianteActual);


    // Re-asignar Event Listeners de la secciÃ³n MANUAL (donde estaban originalmente)
    if(ciclosChecklistEl) {
        // Clonar el nodo para eliminar listeners anteriores y re-asignar
        const newCiclosChecklistEl = ciclosChecklistEl.cloneNode(true);
        ciclosChecklistEl.parentNode.replaceChild(newCiclosChecklistEl, ciclosChecklistEl);
        newCiclosChecklistEl.addEventListener('change', async () => {
            // Se mantiene el cÃ³digo de la funciÃ³n anonima 'change' del cÃ³digo original
            // ... (el cuerpo de la funcion change del ciclo)
            asignaturasChecklistEl.innerHTML = '';
            asigHintManualEl.style.display = 'none';

            // ciclos seleccionados
            const ciclosSel = Array.from(
                newCiclosChecklistEl.querySelectorAll('input:checked')
            ).map(c => c.value);

            if (ciclosSel.length === 0) return;

            items = [];

            // cargar asignaturas desde Firestore
            for (const ciclo of ciclosSel) {

                const qSnap = await db.collection('clases_definidas')
                .where('ciclo', '==', ciclo)
                .get();

                qSnap.forEach(doc => {
                    const data = doc.data();
                    items.push({
                        ciclo,
                        asignatura: data.asignatura,
                        profesor: data.profesor
                    });
                });
            }

            // si no hay asignaturas
            if (items.length === 0) {
                asigHintManualEl.style.display = 'block';
                return;
            }

            asignaturasChecklistEl.innerHTML = '';

            // Mostrar agrupadas por ciclo
            ciclosSel.forEach(ciclo => {
                const grupo = items.filter(i => i.ciclo === ciclo);
                if (grupo.length === 0) return;

                const box = document.createElement('div');
                box.style.marginBottom = '12px';

                const title = document.createElement('div');
                title.textContent = `Ciclo ${ciclo}`;
                title.style.fontWeight = '600';
                title.style.marginBottom = '6px';
                box.appendChild(title);

                grupo.forEach(i => {
                    const lbl = document.createElement('label');
                    lbl.style.display = 'block';
                    lbl.style.marginLeft = '14px';
                    lbl.style.marginBottom = '3px';

                    lbl.innerHTML = `
                        <input type="checkbox" value="${i.ciclo}||${i.asignatura}">
                        ${i.asignatura} 
                        <span style="color:#777;font-size:0.9em">(${i.profesor})</span>
                    `;

                    // CUANDO SELECCIONE UNA ASIGNATURA â†’ pones profesor automÃ¡ticamente
                    lbl.querySelector("input")?.addEventListener("change", (e) => {
                        if (e.target.checked) {
                             document.getElementById("profesorManual") && (document.getElementById("profesorManual").value = i.profesor);
                        }
                    });

                    box.appendChild(lbl);
                });

                asignaturasChecklistEl.appendChild(box);
            });
            // ... (fin del cuerpo de la funcion change del ciclo)
        });
    }

    document.getElementById("formRegistro")?.addEventListener("submit", async function (e) {
        // Se mantiene el cÃ³digo de la funciÃ³n anonima 'submit' del cÃ³digo original
        // ... (cuerpo de la funcion submit)
        e.preventDefault();

        const nombre = document.getElementById("nombre").value.trim();
        let cedula = document.getElementById("cedula").value.trim();
        if (cedula.length === 9) cedula = "0" + cedula;

        const asignaturasSeleccionadas = Array.from(
            asignaturasChecklistEl.querySelectorAll('input:checked')
        ).map(i => {
            const [ciclo, asignatura] = i.value.split("||");
            const prof = items.find(x => x.ciclo === ciclo && x.asignatura === asignatura);
            return {
                ciclo: Number(ciclo),
                asignatura,
                profesor: prof ? prof.profesor : ""
            };
        });

        if (asignaturasSeleccionadas.length === 0) {
            alert("Selecciona al menos una asignatura.");
            return;
        }

        const payload = {
            nombre,
            cedula,
            celular: document.getElementById("celular").value.trim() || "",
            correo_personal: document.getElementById("correo_personal").value.trim() || "",
            correo_institucional: document.getElementById("correo_institucional").value.trim() || "",
            canton_actual: document.getElementById("canton_actual").value.trim() || ""
        };

        const docRef = db.collection("estudiantes").doc(cedula);
        const docSnap = await docRef.get();

        if (docSnap.exists) {
            const dataActual = docSnap.data();
            let asignaciones = Array.isArray(dataActual.asignaciones) ? dataActual.asignaciones : [];

            asignaturasSeleccionadas.forEach(a => {
                const ya = asignaciones.some(x =>
                    x.ciclo === a.ciclo &&
                    x.asignatura === a.asignatura &&
                    x.profesor === a.profesor
                );
                if (!ya) asignaciones.push(a);
            });

            await docRef.update({
                ...payload,
                asignaciones,
                ciclos: [...new Set(asignaciones.map(a => a.ciclo))],
                profesores: [...new Set(asignaciones.map(a => a.profesor))]
            });

            alert("âœ… Estudiante actualizado");

        } else {

            await docRef.set({
                ...payload,
                asignaciones: asignaturasSeleccionadas,
                ciclos: [...new Set(asignaturasSeleccionadas.map(a => a.ciclo))],
                profesores: [...new Set(asignaturasSeleccionadas.map(a => a.profesor))]
            });

            alert("âœ… Estudiante registrado");
        }

        document.getElementById("formRegistro").reset();
        asignaturasChecklistEl.innerHTML = '';
        asigHintManualEl.style.display = 'none';
        // ... (fin del cuerpo de la funcion submit)
    });
}

// ************************************************************
// 2. BLOQUE DE SEGURIDAD: AUTENTICACIÃ“N Y AUTORIZACIÃ“N
// ************************************************************
const auth = firebase.auth(); 
    
// ----------------------------------------------------
// ğŸ”‘ BLOQUE DE SEGURIDAD: AUTENTICACIÃ“N Y AUTORIZACIÃ“N
// ----------------------------------------------------
auth.onAuthStateChanged(async (user) => {
    
    // 1. Si NO hay usuario logueado, redirigir al login
    if (!user) {
        window.location.href = "login.html"; 
        return;
    }

    // 2. Usuario logueado: Verificar si su UID existe en la colecciÃ³n 'supervisores'
    try {
        const userUid = user.uid;
        const supervisorDoc = await db.collection("supervisores").doc(userUid).get();

        if (supervisorDoc.exists) {
            // ğŸ”‘ ACCESO CONCEDIDO
            document.body.style.display = 'block'; // ğŸŸ¢ Mostrar la pÃ¡gina
            
            // ğŸ“ LLAMAR a la funciÃ³n que inicia toda la lÃ³gica de la pÃ¡gina
            inicializarGestion(); // LLAMADA AL WRAPPER
            
        } else {
            // Acceso denegado: Logueado, pero no es supervisor
            alert("Acceso denegado. No tienes permisos de supervisor.");
            auth.signOut();
            window.location.href = "login.html";
        }

    } catch (error) {
        console.error("Error verificando supervisor:", error);
        alert("OcurriÃ³ un error en la verificaciÃ³n de seguridad.");
        auth.signOut();
        window.location.href = "login.html";
    }
});
</script>
</body>
</html>
