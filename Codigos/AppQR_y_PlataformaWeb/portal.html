<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Portal | Laboratorio</title>
  <link rel="icon" href="icono-app.png" type="image/png" />
  <meta name="theme-color" content="#1d70b8" />

  <!-- Firebase (compat v9) -->
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>

  <style>
    :root{
      --bg:#f3f6fb;
      --panel:#ffffff;
      --muted:#475569;
      --text:#0f172a;
      --primary:#1d70b8;     /* celeste acadÃ©mico */
      --primary-700:#155e96; /* celeste mÃ¡s oscuro */
      --accent:#f59e0b;
      --stroke:#e5e7eb;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:
        radial-gradient(1200px 800px at 10% -10%, #eef2ff 0%, transparent 55%),
        radial-gradient(900px 500px at 90% 10%, #e2e8f0 0%, transparent 50%),
        var(--bg);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;
      color:var(--text);
      display: none;
    }
    a{color:inherit;text-decoration:none}
    .container{max-width:1200px;margin:0 auto;padding:20px}

    /* Cinta celeste a todo lo ancho */
    .topbar {
      width: 100%;
      border-radius: 0;
      margin-bottom: 18px;
      background-color: var(--primary);
      color: #fff;
      box-shadow: 0 3px 6px rgba(0,0,0,0.15);
      border-bottom: 3px solid var(--primary-700);
    }
    .topbar .container {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }
    .brand {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-width: 0;
    }
    .brand h1 {
      font-size: 20px;
      margin: 0;
      font-weight: 800;
      letter-spacing: .2px;
      text-align: center;
      color: #fff;
    }
    .brand p {
      margin: 0;
      color: #dbeafe;
      font-size: 12px;
      text-align: center;
    }
    .hdr-logo {
      height: 54px;
      width: auto;
      object-fit: contain;
      flex-shrink: 0;
      filter: drop-shadow(0 1px 2px rgba(0,0,0,0.2));
    }
    .actions {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .chip {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      border-radius: 999px;
      background: var(--primary-700);
      color: #fff;
      font-size: 14px;
    }
    .chip small { color: #bfdbfe; }
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      border: none;
      background: var(--primary-700);
      color: #fff;
      padding: 8px 12px;
      border-radius: 12px;
      cursor: pointer;
      transition: .15s;
    }
    .btn:hover { transform: translateY(-1px); background: #134e75; }
    .btn.primary { background: linear-gradient(135deg,var(--primary),var(--primary-700)); color: #fff; }
    .avatar{width:28px;height:28px;border-radius:999px;background:#f1f5f9;display:grid;place-items:center}

    /* Hero */
    .hero {
      border:1px solid var(--stroke);
      background:linear-gradient(180deg,#ffffff, #ffffffcc 70%, #ffffffb3), url('img/hero.png') center/cover no-repeat;
      padding:24px;
      border-radius:20px;
      box-shadow:0 10px 30px rgba(0,0,0,.06);
    }
    .hero h2{margin:0 0 6px;font-size:28px;color:#1e3a8a}
    .hero p{margin:0;color:var(--muted)}

    /* Grid */
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:16px;margin-top:18px}
    .card{
      grid-column:span 6;
      display:flex;flex-direction:column;justify-content:flex-end;
      min-height:160px;position:relative;overflow:hidden;border-radius:18px;
      border:1px solid var(--stroke);background:var(--panel);cursor:pointer;
      transition:transform .2s ease, box-shadow .2s ease, border-color .2s ease;
      box-shadow:0 4px 10px rgba(0,0,0,.05)
    }
    @media (min-width:900px){ .card{grid-column:span 3;} }
    .card:hover{transform:translateY(-2px);border-color:#cbd5e1;box-shadow:0 12px 32px rgba(0,0,0,.12)}
    .card__media{position:absolute;inset:0;opacity:.25;filter:saturate(1.08);background-position:center;background-size:cover}
    .card__fade{position:absolute;inset:0;background:linear-gradient(180deg,transparent 40%, rgba(0,0,0,.35) 100%)}
    .card__content{position:relative;padding:14px}
    .card__title{font-size:18px;font-weight:800;margin:0 0 4px;color:#1e40af}
    .card__desc{margin:0;color:var(--muted);font-size:13px}
    .card__badge{position:absolute;top:10px;left:10px;font-size:12px;background:#1e3a8a;color:#fff;border:1px solid #1e40af;border-radius:999px;padding:6px 10px}
    .card__badge[data-variant="nuevo"]{background:#fde68a;color:#92400e;border-color:#fcd34d}

    /* Footer */
    footer{margin:24px auto 12px;max-width:1200px;color:var(--muted);font-size:12px;text-align:center}

    /* Modal */
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.35);backdrop-filter:blur(2px);padding:16px;z-index:50}
    .modal.show{display:flex}
    .modal__card{width:100%;max-width:420px;border-radius:18px;background:#fff;border:1px solid var(--stroke);box-shadow:0 20px 60px rgba(0,0,0,.15);overflow:hidden}
    .modal__head{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid var(--stroke)}
    .modal__body{padding:16px;display:grid;gap:12px}
    .input{width:100%;padding:10px 12px;border-radius:12px;border:1px solid #cbd5e1;background:#fff;color:var(--text)}
    .row{display:flex;gap:10px;align-items:center;justify-content:space-between}
    .link{color:var(--primary);font-size:12px}
  </style>
</head>
<body>
  <!-- Cinta -->
  <header class="topbar">
    <div class="container">
      <img class="hdr-logo" src="logounl.png" alt="Logo UNL" />
      <div class="brand">
        <h1>Portal de Laboratorio</h1>
        <p>SupervisiÃ³n â€¢ Asistencias â€¢ Equipos â€¢ Estudiantes</p>
      </div>
      <img class="hdr-logo" src="logocit.png" alt="Logo CIT" />

      <div class="actions">
        <div class="chip" id="sessionChip">
          <small>SesiÃ³n:</small>
          <strong id="sessionState">Invitado</strong>
        </div>
        <button class="btn" id="btnPerfil" title="Perfil">
          <span class="avatar">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none"
              xmlns="http://www.w3.org/2000/svg">
              <circle cx="12" cy="8" r="4" stroke="#bfdbfe"/>
              <path d="M4 20c1.5-4 6.5-4 8-4s6.5 0 8 4" stroke="#bfdbfe"/>
            </svg>
          </span>
          <span id="perfilText">Perfil</span>
        </button>
        <button class="btn primary" id="btnLogin">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none"
            xmlns="http://www.w3.org/2000/svg">
            <path d="M15 3h4v18h-4" stroke="white"/>
            <path d="M10 17l5-5-5-5" stroke="white"/>
          </svg>
          <span id="loginText">Iniciar sesiÃ³n</span>
        </button>
      </div>
    </div>
  </header>

  <div class="container">
    <section class="hero">
      <h2>Â¡Bienvenido!</h2>
      <p>Accede a los mÃ³dulos principales desde aquÃ­. Si aÃºn no has iniciado sesiÃ³n, se te pedirÃ¡ al intentar entrar.</p>
    </section>

    <main class="grid">
      <!-- 1) Horarios y Asistencias -->
      <article class="card portal" data-url="hora.html" data-requires-auth="true">
<div class="card__media" style="background-image:url('img/hora.png')"></div>
        <div class="card__fade"></div>
        <div class="card__badge">Principal</div>
        <div class="card__content">
          <h3 class="card__title">Horarios y Asistencias</h3>
          <p class="card__desc">Gestiona horarios, marca y consulta asistencias.</p>
        </div>
      </article>

      <!-- 2) Equipos y Reservas -->
      <article class="card portal" data-url="equipos.html" data-requires-auth="true">
        <div class="card__media" style="background-image:url('img/equipos.png')"></div>

        <div class="card__fade"></div>
        <div class="card__badge">Principal</div>
        <div class="card__content">
          <h3 class="card__title">Equipos y Reservas</h3>
          <p class="card__desc">Disponibilidad, prÃ©stamos y reservas rÃ¡pidas.</p>
        </div>
      </article>

      <!-- 3) Lista de Estudiantes (NUEVO) -->
      <article class="card portal" data-url="estudiantes.html" data-requires-auth="true">
<div class="card__media" style="background-image:url('img/estudiantes.png')"></div>
        <div class="card__fade"></div>
        <div class="card__badge">Principal</div>
        <div class="card__content">
          <h3 class="card__title">Lista de Estudiantes</h3>
          <p class="card__desc">Consulta y bÃºsqueda avanzada de estudiantes.</p>
        </div>
      </article>

      <!-- 4) Registro de Estudiantes -->
      <article class="card portal" data-url="registro.html" data-requires-auth="true">
<div class="card__media" style="background-image:url('img/registro.png')"></div>
        <div class="card__fade"></div>
        <div class="card__badge">Principal</div>
        <div class="card__content">
          <h3 class="card__title">Registro de Estudiantes</h3>
          <p class="card__desc">Alta, ediciÃ³n y asignaciÃ³n a grupos.</p>
        </div>
      </article>

      <!-- 5) Reportes y EstadÃ­sticas -->
      <article class="card portal" data-url="reportes.html" data-requires-auth="true">
<div class="card__media" style="background-image:url('img/reportes.png')"></div>
        <div class="card__fade"></div>
        <div class="card__badge" data-variant="nuevo">Nuevo</div>
        <div class="card__content">
          <h3 class="card__title">Reportes y EstadÃ­sticas</h3>
          <p class="card__desc">Asistencia, uso de equipos y tendencias.</p>
        </div>
      </article>

      <!-- 6) Recursos y DocumentaciÃ³n (NUEVO) -->
      <article class="card portal" data-url="recursos.html" data-requires-auth="true">
<div class="card__media" style="background-image:url('img/recursos.png')"></div>
        <div class="card__fade"></div>
        <div class="card__badge" data-variant="nuevo">Nuevo</div>
        <div class="card__content">
          <h3 class="card__title">Recursos y DocumentaciÃ³n</h3>
          <p class="card__desc">Manuales, normas del laboratorio y guÃ­as rÃ¡pidas.</p>
        </div>
      </article>
    </main>
  </div>

  <footer>
    Â© <span id="year"></span> Laboratorio. Todos los derechos reservados.
  </footer>

  <!-- Modal Login -->
  <div class="modal" id="loginModal" aria-hidden="true">
    <div class="modal__card" role="dialog" aria-modal="true">
      <div class="modal__head">
        <strong>Iniciar sesiÃ³n</strong>
        <button class="btn" id="btnCerrarModal" aria-label="Cerrar">âœ•</button>
      </div>
      <div class="modal__body">
        <label>
          <small>Usuario o correo</small>
          <input class="input" id="identificador" type="text" placeholder="usuario o usuario@institucion.edu" />
        </label>
        <label>
          <small>ContraseÃ±a</small>
          <input class="input" id="pass" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" />
        </label>
        <div class="row">
          <a class="link" href="#" id="recuperar">Â¿Olvidaste tu contraseÃ±a?</a>
          <button class="btn primary" id="btnConfirmarLogin">Entrar</button>
        </div>
        <small style="color:var(--muted)">Debes tener cuenta creada en <strong>supervisores</strong> (activo y rol supervisor).</small>
      </div>
    </div>
  </div>

 <script>
Â  Â  // ========= Firebase =========
Â  Â  const firebaseConfig = {
Â  Â  Â  apiKey: "AIzaSyBByttCwTn1hMwo9X5P2gbsYlSq9lGa7t0",
Â  Â  Â  authDomain: "escaner-qr-d7d65.firebaseapp.com",
Â  Â  Â  projectId: "escaner-qr-d7d65",
Â  Â  Â  storageBucket: "escaner-qr-d7d65.appspot.com",
Â  Â  Â  messagingSenderId: "982923527298",
Â  Â  Â  appId: "1:982923527298:web:df13850f38d847cfdae09b"
Â  Â  };
Â  Â  firebase.initializeApp(firebaseConfig);
Â  Â  const auth = firebase.auth();
Â  Â  const db Â  = firebase.firestore();

Â  Â  // ========= Utilidades sesiÃ³n local (Se mantienen para uso interno) =========
Â  Â  const isLoggedIn = () => localStorage.getItem('sesion') === 'on';
Â  Â  const setLoggedIn = (v) => localStorage.setItem('sesion', v ? 'on' : 'off');
Â  Â  const setProfile = (obj) => localStorage.setItem('perfil', JSON.stringify(obj || {}));
Â  Â  const getProfile = () => { try{ return JSON.parse(localStorage.getItem('perfil')||'{}'); }catch{return {}} };

Â  Â  // ========= UI refs =========
Â  Â  document.getElementById('year').textContent = new Date().getFullYear();
Â  Â  const loginModal = document.getElementById('loginModal');
Â  Â  const btnLogin = document.getElementById('btnLogin');
Â  Â  const btnPerfil = document.getElementById('btnPerfil');
Â  Â  const btnCerrarModal = document.getElementById('btnCerrarModal');
Â  Â  const btnConfirmarLogin = document.getElementById('btnConfirmarLogin');
Â  Â  const sessionState = document.getElementById('sessionState');
Â  Â  const perfilText = document.getElementById('perfilText');
Â  Â  const loginText = document.getElementById('loginText');

Â  Â  function renderSession(){
Â  Â  Â  const p = getProfile();
Â  Â  Â  if(isLoggedIn()){
Â  Â  Â  Â  sessionState.textContent = 'Activa';
Â  Â  Â  Â  perfilText.textContent = p?.nombre ? p.nombre : 'Perfil';
Â  Â  Â  Â  loginText.textContent = 'Cerrar sesiÃ³n';
Â  Â  Â  Â  btnLogin.classList.remove('primary');
Â  Â  Â  } else {
Â  Â  Â  Â  sessionState.textContent = 'Invitado';
Â  Â  Â  Â  perfilText.textContent = 'Perfil';
Â  Â  Â  Â  loginText.textContent = 'Iniciar sesiÃ³n';
Â  Â  Â  Â  btnLogin.classList.add('primary');
Â  Â  Â  }
Â  Â  }
Â  Â  function openModal(){ loginModal.classList.add('show'); loginModal.setAttribute('aria-hidden','false'); }
Â  Â  function closeModal(){ loginModal.classList.remove('show'); loginModal.setAttribute('aria-hidden','true'); }

Â  Â  // ========= Resolver email desde usuario o correo =========
Â  Â  async function resolveEmailFromIdentifier(identifier){
Â  Â  Â  const id = (identifier||'').trim();
Â  Â  Â  if(!id) throw new Error('Ingresa usuario o correo');
Â  Â  Â  if(id.includes('@')) return id; // ya es correo

Â  Â  Â  // Buscar en colecciÃ³n 'supervisores' por usernameLower
Â  Â  Â  const uname = id.toLowerCase();
Â  Â  Â  const q = await db.collection('supervisores')
Â  Â  Â  Â  .where('usernameLower','==',uname)
Â  Â  Â  Â  .where('activo','==',true)
Â  Â  Â  Â  .limit(1)
Â  Â  Â  Â  .get();

Â  Â  Â  if(q.empty) throw new Error('Usuario no encontrado o inactivo');
Â  Â  Â  const doc = q.docs[0].data();
Â  Â  Â  if(!doc.correo_personal) throw new Error('Supervisor sin correo registrado');
Â  Â  Â  return doc.correo_personal;
Â  Â  }

Â  Â  // ========= Verificar que el usuario logueado sea supervisor activo =========
Â  Â  async function verifySupervisor(user){
Â  Â  Â  const uid = user?.uid;
Â  Â  Â  if(!uid) return false;

Â  Â  Â  const ref = db.collection('supervisores').doc(uid);
Â  Â  Â  const snap = await ref.get();
Â  Â  Â  if(!snap.exists) return false;

Â  Â  Â  const data = snap.data();
Â  Â  Â  const ok = !!(data.activo === true && data.role === 'supervisor');
Â  Â  Â  if(ok){
Â  Â  Â  Â  setProfile({
Â  Â  Â  Â  Â  uid,
Â  Â  Â  Â  Â  nombre: data.nombre || 'Supervisor',
Â  Â  Â  Â  Â  username: data.username || '',
Â  Â  Â  Â  Â  correo: data.correo_personal || user.email || '',
Â  Â  Â  Â  Â  fotoBase64: data.fotoBase64 || ''
Â  Â  Â  Â  });
Â  Â  Â  }
Â  Â  Â  return ok;
Â  Â  }

// ----------------------------------------------------
// ðŸ›‘ Bloque de seguridad estricta (MANTENER ESTE)
// ----------------------------------------------------
Â  auth.onAuthStateChanged(async user => {
Â  Â  const ok = await verifySupervisor(user);
Â  Â  
Â  Â  // Si no estÃ¡ autorizado o no hay usuario, redirige inmediatamente.
Â  Â  if(!ok){
Â  Â  Â  window.location.href = "login.html";
Â  Â  Â  return; // Detener ejecuciÃ³n.
Â  Â  }

Â  Â  // Si es supervisor activo, actualiza la sesiÃ³n y muestra el contenido.
Â  Â  setLoggedIn(true);
Â  Â  renderSession();
Â  Â  // Opcional: Mostrar el body si estaba oculto por CSS
Â  Â  document.body.style.display = 'block'; 
Â  });
// ----------------------------------------------------
// ðŸ›‘ Fin Bloque de seguridad estricta
// ----------------------------------------------------

Â  Â  // ========= Eventos (se mantienen, solo necesitamos que funcionen 'Cerrar SesiÃ³n' y el Modal) =========
Â  Â  btnLogin.addEventListener('click', async () => {
Â  Â  Â  if(isLoggedIn()){
Â  Â  Â  Â  // Cerrar sesiÃ³n completa
Â  Â  Â  Â  try { await auth.signOut(); } catch(e){}
Â  Â  Â  Â  setLoggedIn(false); setProfile({});
Â  Â  Â  Â  renderSession();
Â  Â  Â  Â  // Redirigir despuÃ©s de cerrar sesiÃ³n, ya que el portal requiere supervisor.
Â  Â  Â  Â  window.location.href = "login.html"; 
Â  Â  Â  } else {
Â  Â  Â  Â  openModal();
Â  Â  Â  }
Â  Â  });

Â  Â  btnPerfil.addEventListener('click', () => {
Â  Â  Â  if(isLoggedIn()){
Â  Â  Â  Â  // window.location.href = 'perfil.html'; // opcional
Â  Â  Â  Â  alert('SesiÃ³n activa: ' + (getProfile().nombre || 'Supervisor'));
Â  Â  Â  } else {
Â  Â  Â  Â  openModal();
Â  Â  Â  }
Â  Â  });

Â  Â  btnCerrarModal.addEventListener('click', closeModal);
Â  Â  loginModal.addEventListener('click', (e)=>{ if(e.target === loginModal) closeModal(); });

Â  Â  btnConfirmarLogin.addEventListener('click', async () => {
Â  Â  Â  const idEl = document.getElementById('identificador');
Â  Â  Â  const passEl Â = document.getElementById('pass');
Â  Â  Â  const ident = idEl.value.trim();
Â  Â  Â  const pass Â = passEl.value.trim();

Â  Â  Â  if(!ident || !pass){ alert('Completa usuario/correo y contraseÃ±a'); return; }

Â  Â  Â  try{
Â  Â  Â  Â  const email = await resolveEmailFromIdentifier(ident);
Â  Â  Â  Â  const cred Â = await auth.signInWithEmailAndPassword(email, pass);
Â  Â  Â  Â  const okSupervisor = await verifySupervisor(cred.user);
Â  Â  Â  Â  if(!okSupervisor){
Â  Â  Â  Â  Â  await auth.signOut();
Â  Â  Â  Â  Â  throw new Error('No autorizado: tu cuenta no es supervisor activo.');
Â  Â  Â  Â  }
Â  Â  Â  Â  setLoggedIn(true);
Â  Â  Â  Â  renderSession();
Â  Â  Â  Â  closeModal();
Â  Â  Â  Â  // Recarga la pÃ¡gina despuÃ©s de iniciar sesiÃ³n para re-validar la seguridad estricta
Â  Â  Â  Â  window.location.reload(); 
Â  Â  Â  }catch(err){
Â  Â  Â  Â  alert('Error de inicio de sesiÃ³n: ' + (err?.message || err));
Â  Â  Â  }
Â  Â  });

Â  Â  // ========= NavegaciÃ³n con guardia de sesiÃ³n (se mantiene) =========
Â  Â  document.querySelectorAll('.portal').forEach(card => {
Â  Â  Â  card.addEventListener('click', () => {
Â  Â  Â  Â  const url = card.dataset.url;
Â  Â  Â  Â  // Puesto que la pÃ¡gina misma ya exige ser supervisor, la guardia en la tarjeta ya no es estrictamente necesaria, 
        // pero la mantenemos por si decides relajar la seguridad de la pÃ¡gina principal mÃ¡s adelante.
Â  Â  Â  Â  url && (window.location.href = url);
Â  Â  Â  });
Â  Â  });
    
    // ðŸ›‘ SE ELIMINA EL BLOQUE FINAL 'auth.onAuthStateChanged' (Estado inicial) para evitar duplicidad y garantizar que el primer bloque de redirecciÃ³n estricta tome el control.
    
</script>
</body>
</html>
